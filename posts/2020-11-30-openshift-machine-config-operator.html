<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Using the OpenShift Machine Config Operator</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'openshift'." href="../tags/openshift.html">openshift</a>
    
</div>

<div id="postContent">
    <h1 id="using-the-openshift-machine-config-operator">Using the OpenShift Machine Config Operator</h1>
<p>In a <a href="2020-11-05-openshift-user-namespace.html">recent post</a> I discussed how OpenShift and Kubernetes do not have user namespace isolation. An <a href="https://github.com/cri-o/cri-o/pull/3944">upcoming CRI-O enhancement</a> should allow pods to be run in separate user namespaces. This feature is controlled via <em>annotations</em>; no explicit Kubernetes support is required.</p>
<p>To experiment with this feature I deployed an OpenShift nightly (4.7) cluster, which uses a CRI-O v1.20 prerelease build. But having CRI-O v1.20 is not enough. The feature must be explicitly enabled in the CRI-O configuration. This leads to the question, <em>what is the proper way to manage machine configuration in an OpenShift cluster?</em> The answer is the <em>Machine Config Operator (MCO)</em>.</p>
<p>The <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.6/html/post-installation_configuration/post-install-machine-configuration-tasks">official OpenShift documentation</a> does a good job of introducing and explaining the MCO, so there’s no need to regurgitate it all here. Instead I’ll review the configuration, object definitions and procedure from my CRI-O use case.</p>
<h2 id="configuring-cri-o-via-the-machine-config-operator">Configuring CRI-O via the Machine Config Operator</h2>
<p>CRI-O is configured via <code>/etc/crio/crio.conf</code> and additional files in the <code>/etc/crio/crio.conf.d/</code> directory. Directives from <code>crio.conf.d</code> files have higher precedence and files are processed in lexicographic order.</p>
<p>The follow configuration enables the user namespaces feature:</p>
<pre><code>[crio.runtime.runtimes.runc]
allowed_annotations=[&quot;io.kubernetes.cri-o.userns-mode&quot;]</code></pre>
<p>I used MCO to drop that configuration snippet into the file <code>/etc/crio/crio.conf.d/99-crio-userns.conf</code>. First I needed the base64 encoding of the configuration content:</p>
<pre><code>$ base64 --wrap=0 &lt;&lt;EOF
[crio.runtime.runtimes.runc]
allowed_annotations=[&quot;io.kubernetes.cri-o.userns-mode&quot;]
EOF
W2NyaW8ucnVudGltZS5ydW50aW1lcy5ydW5jXQphbGxvd2VkX2Fubm90YXRpb25zPVsiaW8ua3ViZXJuZXRlcy5jcmktby51c2VybnMtbW9kZSJdCg==</code></pre>
<p>Next I created <code>machineconfig-crio-userns.yaml</code>. This defines a <code>MachineConfig</code>, the primary resource type handled by the MCO. The base64 output from above is used in this file.</p>
<pre><code>apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: crio-userns
spec:
  config:
    ignition:
      version: 3.1.0
    storage:
      files:
      - path: /etc/crio/crio.conf.d/99-crio-userns.conf
        overwrite: true
        contents:
          source: data:text/plain;charset=utf-8;base64,W2NyaW8ucnVudGltZS5ydW50aW1lcy5ydW5jXQphbGxvd2VkX2Fubm90YXRpb25zPVsiaW8ua3ViZXJuZXRlcy5jcmktby51c2VybnMtbW9kZSJdCg==</code></pre>
<p>Note that the examples in the official documentation contain a lot of extraneous fields that can be omitted. <code>MachineConfig</code> objects use the <em>Ignition</em> configuration format. Read the <a href="https://github.com/coreos/ignition/blob/master/docs/configuration-v3_1.md">Ignition Configuration Specification</a> to see what fields are available or required (or not) for your use case.</p>
<p>There are just a few things about this <code>MachineConfig</code> that I’d like to highlight.</p>
<ul>
<li>For creating files, the <code>mode</code> field allows specifying the file access permissions. The default is <code>420</code> (<em>decimal!</em>, equivalent to <code>0644</code>); this was suitable for my use case so I omitted it. But there may be many cases where the default is not suitable and it will be necessary to specify the <code>mode</code>.</li>
<li>This config only needs to be applied on worker nodes. The <code>machineconfiguration.openshift.io/role: worker</code> label accomplishes this. The value <code>master</code> can be used for master-only configurations.</li>
<li>The file content is specified via a <a href="https://tools.ietf.org/html/rfc2397">"data" URI</a>. Other supported schemes include <code>https</code>, <code>s3</code> and <code>tftp</code>.</li>
</ul>
<p>Next I created the <code>MachineConfig</code> object:</p>
<pre><code>$ oc create -f machineconfig-crio-userns.yaml
machineconfig.machineconfiguration.openshift.io/crio-userns created</code></pre>
<p>Over the next several minutes, the Machine Config Operator applied the configuration change to all the worker nodes and restarted them.</p>
<h2 id="closing-thoughts">Closing thoughts</h2>
<p>Everything went smoothly and my impressions of MCO, from this first “hands on” experience, are very positive. It was a simple use case, I admit. But I am still very pleased that it was so easy and everything Just Worked. Hopefully other people have as good an experience with MCO as I did, even for more complex configuration changes.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2020-11-30-openshift-machine-config-operator.html">Using the OpenShift Machine Config Operator</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-13-acme-service-discovery.html">ACME Service Discovery</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-05-openshift-user-namespace.html">OpenShift and user namespaces</a>
        </li>
    
        <li>
            <a href="../posts/2020-10-20-ipa-cert-long-hostname.html">Issuing certificates for long hostnames</a>
        </li>
    
        <li>
            <a href="../posts/2020-09-17-dogtag-vlv-corruption.html">Dogtag, number ranges and VLV indices</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
