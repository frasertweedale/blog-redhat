<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - FreeIPA CA renewal master explained</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'freeipa'." href="../tags/freeipa.html">freeipa</a>, <a title="All pages tagged 'certificates'." href="../tags/certificates.html">certificates</a>, <a title="All pages tagged 'internals'." href="../tags/internals.html">internals</a>, <a title="All pages tagged 'renewal'." href="../tags/renewal.html">renewal</a>
    
</div>

<div id="postContent">
    <h1 id="freeipa-ca-renewal-master-explained">FreeIPA CA renewal master explained</h1>
<p>Every FreeIPA deployment has a critical setting called the <em>CA renewal master</em>. In this post I explain how this setting is used, why it is important, and the consequences of improper configuration. I’ll also discuss scenarios which cause the value to change, and why and how you would change it manually.</p>
<h2 id="what-is-the-ca-renewal-master">What is the CA renewal master? <a href="#what-is-the-ca-renewal-master">§</a></h2>
<p>The CA renewal master configuration controls which CA replica is responsible for renewing some important certificate used within a FreeIPA deployment. I will call these <em>system certificates</em>.</p>
<p>Unlike service certificates (e.g. for HTTP and LDAP) which have different keypairs and subject names on different servers, FreeIPA system certificates, and their keys, are shared by all CA replicas. These include the IPA CA certificate, OCSP certificate, Dogtag subsystem certificates, Dogtag audit signing certificate, IPA RA agent certificate and KRA transport and storage certificates.</p>
<p>The current CA renewal master configuration can be viewed via <code>ipa config-show</code>:</p>
<pre><code>[f28-1] ftweedal% ipa config-show | grep 'CA renewal master'
  IPA CA renewal master: f28-1.ipa.local</code></pre>
<p>Under the hood, this configuration is a <em>server role attribute</em>. The CA renewal master is indicated by the presence of an <code>(ipaConfigString=caRenewalMaster)</code> attribute value on an IPA server’s CA role object. You can determine the renewal master via a plain LDAP search:</p>
<pre><code>[f28-1] ftweedal% ldapsearch -LLL \
      -D &quot;cn=Directory Manager&quot; \
      &quot;(ipaConfigString=carenewalmaster)&quot;
dn: cn=CA,cn=f28-1.ipa.local,cn=masters,cn=ipa,cn=etc,dc=ipa,dc=local
objectClass: nsContainer
objectClass: ipaConfigObject
objectClass: top
cn: CA
ipaConfigString: startOrder 50
ipaConfigString: caRenewalMaster
ipaConfigString: enabledService</code></pre>
<p>The configuration is automatically set to the first master in the topology on which the CA role was installed. Unless you installed without a CA, this is the original master set up via <code>ipa-server-install</code>.</p>
<h2 id="what-problem-is-solved-by-having-a-ca-renewal-master">What problem is solved by having a CA renewal master? <a href="#what-problem-is-solved-by-having-a-ca-renewal-master">§</a></h2>
<p>All CA replicas have tracking requests for all system certificates. But if all CA replicas renewed system certificates independently, they would end up with different certificates. This is especially a problem for the CA certificate, and the subsystem and IPA RA certificates which get stored in LDAP for authentication purposes. The certificates must match exactly, otherwise there will be authentication failures between the FreeIPA framework and Dogtag, and between Dogtag and LDAP.</p>
<p>Appointing one CA replica as the renewal master allows the system certificates to be renewed exactly once, when required.</p>
<h3 id="how-do-other-replicas-acquire-the-updated-certificates">How do other replicas acquire the updated certificates? <a href="#how-do-other-replicas-acquire-the-updated-certificates">§</a></h3>
<p>The Certmonger tracking requests on all CA replicas use the <code>dogtag-ipa-ca-renew-agent</code> renewal helper. This program reads the CA renewal master configuration. If the current host is the renewal master, it performs the renewal, and stores the certificate in LDAP under <code>cn=&lt;nickname&gt;,cn=ca_renewal,cn=ipa,cn=etc,{basedn}</code>. Additionally, if the certificate is the IPA RA or the Dogtag CA subsystem certificate, the new certificate gets added to the <code>userCertificate</code> attribute of the corresponding LDAP user entry</p>
<p>If the renewal master is a different host, the latest certificate is retrieved from the <code>ca_renewal</code> LDAP entry and returned to Certmonger. Due to non-determinism in exactly when Certmonger renewal attempts will occur, the non-renewal helper could attempt to “renew” the certificate before the renewal master has actually renewed the certificate. So it is <em>not an error</em> for the renewal helper to return the old (soon to expire) certificate. Certmonger will keep attempting to renew the certificate (with some delay between attempts) until it can retrieve the updated certificate (which will not expire soon).</p>
<h2 id="what-can-go-wrong">What can go wrong? <a href="#what-can-go-wrong">§</a></h2>
<p>If it wasn’t clear already, a (CA-ful) FreeIPA deployment must at all times have exactly one CA replica configured as the renewal master. That server must be online, operating normally, and replicating properly with other servers. Let’s look at what happens if these conditions are not met.</p>
<p>If the CA renewal master configuration refers to a server that has been decommissioned, or is offline, then no server will actually renew the certificates. All the non-renewal master servers will happily reinstall the current certificate, until they expire, and things will break. The troublesome thing about certificates is even one expired certificate can cause renewal failures for other certificates. The problems cascade and eventually the whole deployment is busted.</p>
<p>FreeIPA has a simple protection in place to ensure the renewal master configuration stays valid. Servers can be deleted from the topology via the <code>ipa server-del</code>, <code>ipa-replica-manage del</code>, <code>ipa-csreplica-manage del</code> or <code>ipa-server-install --uninstall</code> command. In these commands, if the server being deleted is the current CA renewal master, a different CA replica is elected as the new CA renewal master.</p>
<p>These protections only go so far. If the renewal master is still part of the topology but is offline for an extended duration it may miss a renewal window, causing expired certificates. If there are replication problems between the renewal master and other CA replicas, renewal might succeed, but the other CA replicas might not be able to retrieve the updated certificates before they expire. All of these problems (and more) have been seen in the wild.</p>
<p>I have seen cases where a CA renewal master was simply decommissioned without formally removing it from the FreeIPA topology. I have also seen cases where there was no CA renewal master configured (I do not know how this situation arose). Both of these scenarios have similar consequences to the “offline for extended duration” scenario.</p>
<p>What would happen if you had two (or more) CA replicas with <code>(ipaConfigString=caRenewalMaster)</code>? I haven’t seen this one in the wild, but I would not be surprised if one day I did see it. In this case, multiple CA replicas will perform renewals. Will clobber each others’ certificates, and will result in some replicas having RA Agent or Dogtag subsystem certificates out of sync with the corresponding user entries in LDAP. This is a less catastrophic consequence than the aforementioned scenarios, but still serious. It will result in Dogtag or IPA RA authentication failures on some (or most) CA replicas.</p>
<h2 id="why-and-how-to-change-the-ca-renewal-master">Why and how to change the CA renewal master <a href="#why-and-how-to-change-the-ca-renewal-master">§</a></h2>
<p>Why would you need to change the renewal master configuration? Assuming the existing configuration is valid, the main reason you would need to change it is in anticipation of the decommissioning of the existing CA renewal master. You may wish to appoint a particular server as the new renewal master. As discussed above, the commands that remove servers from the topology will do this automatically, but <em>which server</em> will be chosen is out of your hands. So you can get one step ahead and change the renewal master yourself.</p>
<p>In my test setup there are two CA replicas:</p>
<pre><code>[f28-1] ftweedal% ipa server-role-find --role 'CA server'
----------------------
2 server roles matched
----------------------
  Server name: f28-0.ipa.local
  Role name: CA server
  Role status: enabled

  Server name: f28-1.ipa.local
  Role name: CA server
  Role status: enabled
----------------------------
Number of entries returned 2
----------------------------</code></pre>
<p>The current renewal master is <code>f28-1.ipa.local</code>:</p>
<pre><code>[f28-1] ftweedal% ipa config-show | grep 'CA renewal master'
  IPA CA renewal master: f28-1.ipa.local</code></pre>
<p>The preferred way to change the renewal master configuration is via the <code>ipa config-mod</code> command:</p>
<pre><code>[f28-1] ftweedal% ipa config-mod \
      --ca-renewal-master-server f28-0.ipa.local \
      | grep 'CA renewal master'
  IPA CA renewal master: f28-0.ipa.local</code></pre>
<p>You can also use the <code>ipa-csreplica-manage</code> command. This requires the <code>Directory Manager</code> passphrase:</p>
<pre><code>[f28-1] ftweedal% ipa-csreplica-manage \
                    set-renewal-master f28-1.ipa.local
Directory Manager password: XXXXXXXX

f28-1.ipa.local is now the renewal master</code></pre>
<p>If for whatever reason the current renewal master configuration is invalid, you can use these same commands to reset it. As a last resort, you can modify the LDAP objects directly to ensure that exactly one CA role object has <code>(ipaConfigString=caRenewalMaster)</code>. Note that both the attribute name (<code>ipaConfigString</code>) and value (<code>caRenewalMaster</code>) are case-<em>insensitive</em>.</p>
<p>Finally, let’s observe what happens when we remove a server from the topology. I’ll remove <code>f28-1.ipa.local</code> (the current renewal master) using the <code>ipa-server-install --uninstall</code> command. After this operation, the CA renewal master configuration should point to <code>f28-0.ipa.local</code> (the only other CA replica in the topology).</p>
<pre><code>[f28-1:~] ftweedal% sudo ipa-server-install --uninstall

This is a NON REVERSIBLE operation and will delete all data
and configuration!
It is highly recommended to take a backup of existing data
and configuration using ipa-backup utility before proceeding.

Are you sure you want to continue with the uninstall procedure? [no]: yes
Forcing removal of f28-1.ipa.local
Failed to cleanup f28-1.ipa.local DNS entries: DNS is not configured
You may need to manually remove them from the tree
------------------------------------
Deleted IPA server &quot;f28-1.ipa.local&quot;
------------------------------------
Shutting down all IPA services
Unconfiguring CA
... (snip!)
Client uninstall complete.
The ipa-client-install command was successful
The ipa-server-install command was successful</code></pre>
<p>Jumping across to <code>f28-0.ipa.local</code>, I confirm that <code>f28-0.ipa.local</code> has become the renewal master:</p>
<pre><code>[f28-0] ftweedal% ipa config-show |grep 'CA renewal master'
  IPA CA renewal master: f28-0.ipa.local</code></pre>
<h2 id="explicit-ca-certificate-renewal">Explicit CA certificate renewal <a href="#explicit-ca-certificate-renewal">§</a></h2>
<p>There is one more scenario that can cause the CA renewal master to be changed. When the IPA CA certificate is explicitly renewed via the <code>ipa-cacert-manage renew</code> command the server on which the operation is performed becomes the CA renewal master. This is to cause the CA replica that <em>was</em> the renewal master to retrieve the new CA certificate from LDAP instead of renewing it.</p>
<h2 id="conclusion">Conclusion <a href="#conclusion">§</a></h2>
<p>In this post I explained what the CA renewal master configuration is for and what it looks like under the hood. For FreeIPA/Dogtag system certificates, the CA renewal master configuration controls which CA replica actually performs renewal. The CA renewal master stores the renewed certificates in LDAP, and all other CA replicas look for them there. The <code>dogtag-ipa-ca-renew-agent</code> Certmonger renewal helper implements both of these behaviours, using the CA renewal master configuration to decide which behaviour to execute.</p>
<p>There must be exactly one CA renewal master in a topology and it must be operational. I discussed the consequences of various configuration or operational problems. I also explained why you might want to change the CA renewal master, and how to do it.</p>
<p>The CA renewal master is a critical configuration and incorrect renewal master configuration is often a factor in complex customer cases involving FreeIPA’s PKI. Commands that remove servers from the topology <em>should</em> elect a new CA renewal master when necessary. But misconfigurations do arise (if only we could know all the ways how!)</p>
<p>The upcoming FreeIPA <a href="https://www.freeipa.org/page/V4/Healthcheck">Healthcheck</a> feature will, among other checks, confirm that the CA renewal master configuration is sane. It will not (in the beginning at least) be able to diagnose availability or connectivity issues. But it should be able to catch some misconfigurations before they lead to catastrophic failure of the deployment.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2021-06-29-openshift-live-changes.html">Testing changes on live OpenShift nodes</a>
        </li>
    
        <li>
            <a href="../posts/2021-06-09-systemd-cgroups-subuid.html">systemd, cgroups and subuid ranges</a>
        </li>
    
        <li>
            <a href="../posts/2021-05-27-oci-runtime-spec-runc.html">Using <code>runc</code> to explore the OCI Runtime Specification</a>
        </li>
    
        <li>
            <a href="../posts/2021-03-30-openshift-cgroupv2-systemd.html">systemd containers on OpenShift with cgroups v2</a>
        </li>
    
        <li>
            <a href="../posts/2021-03-10-openshift-user-namespace-multi-user.html">Multiple users in user namespaces on OpenShift</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
