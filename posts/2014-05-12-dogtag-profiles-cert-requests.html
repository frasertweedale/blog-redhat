<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Dogtag certificate profiles - certificate requests</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1 id="dogtag-certificate-profiles---certificate-requests">Dogtag certificate profiles - certificate requests</h1>
<p>The <em>certificate enrolment profiles</em> feature of Dogtag PKI can be used to specify default values and constraints for X.509 certificate fields. This post explores Dogtag certificate profiles and their relationship with the PKCS #10 certificate signing request (CSR) format with a focus on signing request submission. Future posts in this series will focus on the Certificate Authority (CA) side of the profiles feature, and on modifying and defining profiles for specialised use cases.</p>
<p>Let us begin by generating a CSR. This occurs in isolation from Dogtag profiles or certificate enrolment, and is done using <code>certutil</code> (CSRs can also be generated with <code>openssl req</code>).</p>
<pre><code>certutil -R -d .pki/nssdb -o no-CN.req -a -s 'C=AU, ST=Queensland, L=Brisbane, O=Red Hat'</code></pre>
<p>The <code>-o no-CN.req</code> instructs <code>certutil</code> to output the CSR to a file, while <code>-a</code> specifies ASCII output. Note that the subject (given by <code>-s</code>) does not contain a common name (CN) component.</p>
<p>CSRs are submitted to Dogtag in the context of some certificate profile. Available profiles can be listed via <code>pki cert-request-profile-find &quot;&quot;</code>, and the Certificate Enrolment Request template for a profile can be retrieved via <code>pki cert-request-profile-show &lt;profile ID&gt; --output &lt;filename&gt;</code>. Let’s have a look at the <code>caServerCert</code> profile template:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;<span class="kw">?&gt;</span>
<span class="kw">&lt;CertEnrollmentRequest&gt;</span>
    <span class="kw">&lt;ProfileID&gt;</span>caServerCert<span class="kw">&lt;/ProfileID&gt;</span>
    <span class="kw">&lt;Renewal&gt;</span>false<span class="kw">&lt;/Renewal&gt;</span>
    <span class="kw">&lt;SerialNumber&gt;&lt;/SerialNumber&gt;</span>
    <span class="kw">&lt;RemoteHost&gt;&lt;/RemoteHost&gt;</span>
    <span class="kw">&lt;RemoteAddress&gt;&lt;/RemoteAddress&gt;</span>
    <span class="kw">&lt;Input</span><span class="ot"> id=</span><span class="st">&quot;i1&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;ClassID&gt;</span>certReqInputImpl<span class="kw">&lt;/ClassID&gt;</span>
        <span class="kw">&lt;Name&gt;</span>Certificate Request Input<span class="kw">&lt;/Name&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;cert_request_type&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>cert_request_type<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Certificate Request Type<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;cert_request&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>cert_request<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Certificate Request<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
    <span class="kw">&lt;/Input&gt;</span>
    <span class="kw">&lt;Input</span><span class="ot"> id=</span><span class="st">&quot;i2&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;ClassID&gt;</span>submitterInfoInputImpl<span class="kw">&lt;/ClassID&gt;</span>
        <span class="kw">&lt;Name&gt;</span>Requestor Information<span class="kw">&lt;/Name&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;requestor_name&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>string<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Requestor Name<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;requestor_email&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>string<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Requestor Email<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;requestor_phone&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>string<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Requestor Phone<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
    <span class="kw">&lt;/Input&gt;</span>
<span class="kw">&lt;/CertEnrollmentRequest&gt;</span></code></pre></div>
<p>The template is XML, containing <em>fields</em> with <em>attributes</em> whose values are not yet specified. Filling out these attributes with the content of the CSR generated earlier along with some ancillary information, we end up with the following:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;<span class="kw">?&gt;</span>
<span class="kw">&lt;CertEnrollmentRequest&gt;</span>
    <span class="kw">&lt;ProfileID&gt;</span>caServerCert<span class="kw">&lt;/ProfileID&gt;</span>
    <span class="kw">&lt;Renewal&gt;</span>false<span class="kw">&lt;/Renewal&gt;</span>
    <span class="kw">&lt;SerialNumber&gt;&lt;/SerialNumber&gt;</span>
    <span class="kw">&lt;RemoteHost&gt;&lt;/RemoteHost&gt;</span>
    <span class="kw">&lt;RemoteAddress&gt;&lt;/RemoteAddress&gt;</span>
    <span class="kw">&lt;Input</span><span class="ot"> id=</span><span class="st">&quot;i1&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;ClassID&gt;</span>certReqInputImpl<span class="kw">&lt;/ClassID&gt;</span>
        <span class="kw">&lt;Name&gt;</span>Certificate Request Input<span class="kw">&lt;/Name&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;cert_request_type&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;</span>pkcs10<span class="kw">&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>cert_request_type<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Certificate Request Type<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;cert_request&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;Value&gt;</span>
MIIBhjCB8AIBADBHMRAwDgYDVQQKEwdSZWQgSGF0MREwDwYDVQQHEwhCcmlzYmFu
ZTETMBEGA1UECBMKUXVlZW5zbGFuZDELMAkGA1UEBhMCQVUwgZ8wDQYJKoZIhvcN
AQEBBQADgY0AMIGJAoGBAJvkY6CyMdY0u7hwFzfG9ZdajT+69bbRh1vqFIArGhhv
vL09Em2MrlAhQEKF6PuAcdED7U7ryoBByeXDRfivFwQS5W5msVBkA5gZ1i9LyH82
xULvkdnNFu6He8QnxLr8+bl/r9tdlktP/3k79hHmWRpqBtOqVKtBCwMqEdPltF7H
AgMBAAGgADANBgkqhkiG9w0BAQUFAAOBgQB5Slu71g30osgQd25puSrUxNf6+eQk
KEpWfrsrpRh7nOkAo3QmBmR4L7i5tUChnIv6UGi8qTeEWNHnMBcwgoe56tg5vqpK
mmaz3W1w8hxima/cSqzqWgw4U/JMDU1nBSYz2WJTyEUUvdDD1lSsWzrqFi5f/vC3
VjjWvio/DSvrgw==
                <span class="kw">&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>cert_request<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Certificate Request<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
    <span class="kw">&lt;/Input&gt;</span>
    <span class="kw">&lt;Input</span><span class="ot"> id=</span><span class="st">&quot;i2&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;ClassID&gt;</span>submitterInfoInputImpl<span class="kw">&lt;/ClassID&gt;</span>
        <span class="kw">&lt;Name&gt;</span>Requestor Information<span class="kw">&lt;/Name&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;requestor_name&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;</span>ftweedal<span class="kw">&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>string<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Requestor Name<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;requestor_email&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;</span>ftweedal@redhat.com<span class="kw">&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>string<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Requestor Email<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
        <span class="kw">&lt;Attribute</span><span class="ot"> name=</span><span class="st">&quot;requestor_phone&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;Value&gt;&lt;/Value&gt;</span>
            <span class="kw">&lt;Descriptor&gt;</span>
                <span class="kw">&lt;Syntax&gt;</span>string<span class="kw">&lt;/Syntax&gt;</span>
                <span class="kw">&lt;Description&gt;</span>Requestor Phone<span class="kw">&lt;/Description&gt;</span>
            <span class="kw">&lt;/Descriptor&gt;</span>
        <span class="kw">&lt;/Attribute&gt;</span>
    <span class="kw">&lt;/Input&gt;</span>
<span class="kw">&lt;/CertEnrollmentRequest&gt;</span></code></pre></div>
<p>With these fields filled out, the enrolment request can now be submitted to Dogtag:</p>
<pre><code>$ pki cert-request-submit no-CN-req.xml
-----------------------------
Submitted certificate request
-----------------------------
  Request ID: 12
  Type: enrollment
  Request Status: rejected
  Operation Result: success</code></pre>
<p>Boo! The enrolment request was rejected. Why? Certificate profiles can specify constraints on user-supplied values in a certificate request. In this case, it was the lack of a <code>CN</code> field in the subject, but profiles can also summarily reject an enrolment request based on other aspects of the embedded CSR, including key type and size.</p>
<p>Let’s now bring some extensions into the mix by generating a new signing request - this time with a valid subject, and with the <em>Key Usage</em> extension configured to indicate a certificate signing certificate (i.e., an intermediate CA). It obviously makes no sense to have this extensions on a server certificate, but let’s submit it with the <code>caServerCert</code> profile again and see what happens.</p>
<pre><code>$ certutil -R -d .pki/nssdb -o usage-ca.req -a --keyUsage certSigning -s 'CN=c2.vm-096.idm.lab.bos.redhat.com'
...
$ openssl req -text &lt; usage-ca.req
Certificate Request:
    Data:
        Version: 0 (0x0)
        Subject: CN=c2.vm-096.idm.lab.bos.redhat.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (1024 bit)
                Modulus:
                    00:bc:6e:11:11:6f:e5:3c:34:03:8a:5f:92:41:44:
                    ...
                    9b:bf:86:8e:df:96:9e:e6:ef
                Exponent: 65537 (0x10001)
        Attributes:
        Requested Extensions:
            X509v3 Key Usage:
                Certificate Sign
    Signature Algorithm: sha1WithRSAEncryption
         b0:4a:19:2c:c1:36:07:db:6a:bb:a9:36:0b:a4:53:c9:39:6d:
         ...</code></pre>
<p>We can see that Key Usage extension is present in the request, and contains (only) the <em>Certificate Sign</em> declaration. We fill out and submit the enrolment request with this CSR:</p>
<pre><code>$ pki cert-request-submit usage-ca-req.xml
-----------------------------
Submitted certificate request
-----------------------------
  Request ID: 14
  Type: enrollment
  Request Status: pending
  Operation Result: success</code></pre>
<p>Perhaps surprisingly, this succeeds and the enrolment request is now <em>pending</em>, waiting for approval (or rejection) by a CA agent. It seems that, at least for the <code>caServerCert</code> profile, the value of the Key Usage extension in a CSR is ignored. The agent interface does allow adjustment of the Key Usage extension, however, and enforces sensible constraints, so no request submitted in the <code>caServerCert</code> profile will ever result in a certificate that could be used as an intermediate CA.</p>
<p>We have seen that Dogtag ignores the Key Usage extension information present in a CSR, but in fact, Dogtag ignores <em>all</em> information in the CSR except for what it specifically extracts. Therefore, requesting a particular key signing algorithm does not necessarily result in a certificate signed using that algorithm, and requesting some extension unknown in the selected profile (e.g., the <em>Certificate Policies</em> extension, which can be included in a CSR via the <code>--extCP</code> argument to <code>certmonger</code>) will <strong>certainly not</strong> be present in the certificate.</p>
<p>As a newcomer to the Dogtag PKI I find this behaviour somewhat limiting and would like to investigate whether the profiles system supports profiles that afford more control over the presense of extensions or the signing process, or what it would take to get this support.</p>
<p>The next post in this series will investigate how profiles are defined and the kinds of inputs and constraints they support.</p>
        </div>
        <div id="footer">
            Generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
