<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Changing a CA’s Subject DN; Part II: FreeIPA</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'freeipa'." href="../tags/freeipa.html">freeipa</a>, <a title="All pages tagged 'certificates'." href="../tags/certificates.html">certificates</a>, <a title="All pages tagged 'howto'." href="../tags/howto.html">howto</a>
    
</div>

<div id="postContent">
    <h1 id="changing-a-cas-subject-dn-part-ii-freeipa">Changing a CA’s Subject DN; Part II: FreeIPA</h1>
<p>In the <a href="2017-11-20-changing-ca-subject-dn-part-i.html">previous post</a> I explained how the CA Subject DN is an
integral part of X.509 any why you should not change it. Doing so
can break path validation, CRLs and OCSP, and many programs will not
copye with the change. I proposed some alternative approaches that
avoid these problems: re-chaining the CA, and creating subordinate
CAs.</p>
<p>If you were thinking of changing your CA’s Subject DN, I hope that I
dissuaded you. But if I failed, or you absolutely do need to change
the Subject DN of your CA, where there’s a will there’s way. The
purpose of this post is to explore how to do this in FreeIPA, and
discuss the implications.</p>
<p>This is a <strong>long post</strong>. If you are really changing the CA subject
DN, don’t skip anything. Otherwise don’t feel bad about skimming
or jumping straight to the <a href="#discussion">discussion</a>. Even
skimming the article will give you an idea of the steps involved,
and how to repair the ensuing breakage.</p>
<h2 id="changing-the-freeipa-cas-subject-dn">Changing the FreeIPA CA’s Subject DN <a href="#changing-the-freeipa-cas-subject-dn" class="section">§</a></h2>
<p>Before writing this post, I had never even attempted to do this. I
am unaware of anyone else trying or whether they were successful.
But the question of how to do it has come up several times, so I
decided to investigate. The format of this post follows my
exploration of the topic as I poked and prodded a FreeIPA
deployment, working towards the goal.</p>
<p>What was the goal? Let me state the goal, and some assumptions:</p>
<ul>
<li>The goal is to give the FreeIPA CA a new Subject DN. The
deployment should look and behave as though it were originally
installed with the new Subject.</li>
<li>We want to keep the old CA certificate in the relevant certificate
stores and databases, alongside the new certificate.</li>
<li>The CA is not being re-keyed (I will deal with re-keying in a
future article).</li>
<li>We want to be able to do this with both self-signed and
externally-signed CAs. It’s okay if the process differs.</li>
<li>It’s okay to have manual steps that the administrator must
perform.</li>
</ul>
<p>Let’s begin on the deployment’s <em>CA renewal master</em>.</p>
<h3 id="certmonger-first-attempt">Certmonger (first attempt) <a href="#certmonger-first-attempt" class="section">§</a></h3>
<p>There is a Certmonger tracking request for the FreeIPA CA, which
uses the <code>dogtag-ipa-ca-renew-agent</code> CA helper. The <code>getcert resubmit</code> command lets you change the Subject DN when you resubmit
a request, via the <code>-N</code> option. I know the internals of the CA
helper and I can see that there will be problems <em>after</em> renewing
the certificate this way. Storing the certificate in the
<code>ca_renewal</code> LDAP container will fail. But the renewal itself
<em>might</em> succeed so I’ll try it and see what happens:</p>
<pre><code>[root@f27-2 ~]# getcert resubmit -i 20171106062742 \
  -N 'CN=IPA.LOCAL CA 2017.11.09'
Resubmitting &quot;20171106062742&quot; to &quot;dogtag-ipa-ca-renew-agent&quot;.</code></pre>
<p>After waiting about 10 seconds for Certmonger to do its thing, I
check the state of the tracking request:</p>
<pre><code>[root@f27-2 ~]# getcert list -i 20171106062742
Request ID '20171106062742':
  status: MONITORING
  CA: dogtag-ipa-ca-renew-agent
  issuer: CN=Certificate Authority,O=IPA.LOCAL 201711061603
  subject: CN=Certificate Authority,O=IPA.LOCAL 201711061603
  expires: 2037-11-06 17:26:21 AEDT
  ... (various fields omitted)</code></pre>
<p>The <code>status</code> and <code>expires</code> fields show that renewal succeeded,
but the certificate still has the old Subject DN. This happened
because the <code>dogtag-ipa-ca-renew-agent</code> helper doesn’t think it is
renewing the CA certificate (which is true!)</p>
<h3 id="modifying-the-ipa-ca-entry">Modifying the IPA CA entry <a href="#modifying-the-ipa-ca-entry" class="section">§</a></h3>
<p>So let’s trick the Certmonger renewal helper.
<code>dogtag-ipa-ca-renew-agent</code> looks up the CA Subject DN in the
<code>ipaCaSubjectDn</code> attribute of the <code>ipa</code> CA entry
(<code>cn=ipa,cn=cas,cn=ca,{basedn}</code>). This attribute is not writeable
via the IPA framework but you can change it using regular LDAP tools
(details out of scope). If the certificate is self-signed you
should also change the <code>ipaCaIssuerDn</code> attribute. After modifying
the entry run <code>ipa ca-show</code> to verify that these attributes have
the desired values:</p>
<pre><code>[root@f27-2 ~]# ipa ca-show ipa
  Name: ipa
  Description: IPA CA
  Authority ID: cdbfeb5a-64d2-4141-98d2-98c005802fc1
  Subject DN: CN=IPA.LOCAL CA 2017.11.09
  Issuer DN: CN=IPA.LOCAL CA 2017.11.09
  Certificate: MIIDnzCCAoegAwIBAgIBCTANBgkqhkiG9w0...</code></pre>
<h3 id="certmonger-second-attempt">Certmonger (second attempt) <a href="#certmonger-second-attempt" class="section">§</a></h3>
<p>Now let’s try and renew the CA certificate via Certmonger again:</p>
<pre><code>[root@f27-2 ~]# getcert resubmit -i 20171106062742 \
  -N 'CN=IPA.LOCAL CA 2017.11.09'
Resubmitting &quot;20171106062742&quot; to &quot;dogtag-ipa-ca-renew-agent&quot;.</code></pre>
<p>Checking the <code>getcert list</code> output after a short wait:</p>
<pre><code>[root@f27-2 ~]# getcert list -i 20171106062742
Request ID '20171106062742':
  status: MONITORING
  CA: dogtag-ipa-ca-renew-agent
  issuer: CN=Certificate Authority,O=IPA.LOCAL 201711061603
  subject: CN=IPA.LOCAL CA 2017.11.09
  expires: 2037-11-09 16:11:12 AEDT
  ... (various fields omitted)</code></pre>
<p>Progress! We now have a CA certificate with the desired Subject DN.
The new certificate has the old (current) issuer DN. We’ll ignore
that for now.</p>
<h3 id="checking-server-health">Checking server health <a href="#checking-server-health" class="section">§</a></h3>
<p>Now I need to check the state of the deployment. Did anything go
wrong during renewal? Is everything working?</p>
<p>First, I checked the Certmonger journal output to see if there were
any problems. The journal contained the following messages (some
fields omitted for brevity):</p>
<pre><code>16:11:17 /dogtag-ipa-ca-renew-agent-submit[1662]: Forwarding request to dogtag-ipa-renew-agent
16:11:17 /dogtag-ipa-ca-renew-agent-submit[1662]: dogtag-ipa-renew-agent returned 0
16:11:19 /stop_pkicad[1673]: Stopping pki_tomcatd
16:11:20 /stop_pkicad[1673]: Stopped pki_tomcatd
16:11:22 /renew_ca_cert[1710]: Updating CS.cfg
16:11:22 /renew_ca_cert[1710]: Updating CA certificate failed: no matching entry found
16:11:22 /renew_ca_cert[1710]: Starting pki_tomcatd
16:11:34 /renew_ca_cert[1710]: Started pki_tomcatd
16:11:34 certmonger[2013]: Certificate named &quot;caSigningCert cert-pki-ca&quot; in token &quot;NSS Certificate DB&quot; in database &quot;/etc/pki/pki-tomcat/alias&quot; issued by CA and saved.</code></pre>
<p>We can see that the renewal succeeded and Certmonger saved the new
certificate in the NSSDB. Unfortunately there was an error in the
<code>renew_ca_cert</code> post-save hook: it failed to store the new
certificate in the LDAP certstore. That should be easy to resolve.
I’ll make a note of that and continue checking deployment health.</p>
<p>Next, I checked whether Dogtag was functioning. <code>systemctl status pki-tomcatd@pki-tomcat</code> and the CA debug log
(<code>/var/log/pki/pki-tomcat/ca/debug</code>) indicated that Dogtag started
cleanly. Even better, the Dogtag NSSDB has the new CA certificate
with the correct nickname:</p>
<pre><code>[root@f27-2 ~]# certutil -d /etc/pki/pki-tomcat/alias \
  -L -n 'caSigningCert cert-pki-ca'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 11 (0xb)
        Signature Algorithm: PKCS #1 SHA-256 With RSA Encryption
        Issuer: &quot;CN=Certificate Authority,O=IPA.LOCAL 201711061603&quot;
        Validity:
            Not Before: Thu Nov 09 05:11:12 2017
            Not After : Mon Nov 09 05:11:12 2037
        Subject: &quot;CN=IPA.LOCAL CA 2017.11.09&quot;
  ... (remaining lines omitted)</code></pre>
<p>We have not yet confirmed that the Dogtag uses the new CA Subject DN as the Issuer DN on new certificates (we’ll check this later).</p>
<p>Now let’s check the state of IPA itself. There is a problem in
communication between the IPA framework and Dogtag:</p>
<pre><code>[root@f27-2 ~]# ipa ca-show ipa
ipa: ERROR: Request failed with status 500: Non-2xx response from CA REST API: 500.</code></pre>
<p>A quick look in <code>/var/log/httpd/access_log</code> showed that it was not
a general problem but only occurred when accessing a particular
resource:</p>
<pre><code>[09/Nov/2017:17:15:09 +1100] &quot;GET https://f27-2.ipa.local:443/ca/rest/authorities/cdbfeb5a-64d2-4141-98d2-98c005802fc1/cert HTTP/1.1&quot; 500 6201</code></pre>
<p>That is a Dogtag <em>lightweight authority</em> resource for the CA
identified by <code>cdbfeb5a-64d2-4141-98d2-98c005802fc1</code>. That is the
<em>CA ID</em> recorded in the FreeIPA <code>ipa</code> CA entry. This gives a hint
about where the problem lies. An <code>ldapsearch</code> reveals more:</p>
<pre><code>[f27-2:~] ftweedal% ldapsearch -LLL \
    -D 'cn=directory manager' -w DM_PASSWORD \
    -b 'ou=authorities,ou=ca,o=ipaca' -s one
dn: cn=cdbfeb5a-64d2-4141-98d2-98c005802fc1,ou=authorities,ou=ca,o=ipaca
authoritySerial: 9
objectClass: authority
objectClass: top
cn: cdbfeb5a-64d2-4141-98d2-98c005802fc1
authorityID: cdbfeb5a-64d2-4141-98d2-98c005802fc1
authorityKeyNickname: caSigningCert cert-pki-ca
authorityEnabled: TRUE
authorityDN: CN=Certificate Authority,O=IPA.LOCAL 201711061603
description: Host authority

dn: cn=008a4ded-fd4b-46fe-8614-68518123c95f,ou=authorities,ou=ca,o=ipaca
objectClass: authority
objectClass: top
cn: 008a4ded-fd4b-46fe-8614-68518123c95f
authorityID: 008a4ded-fd4b-46fe-8614-68518123c95f
authorityKeyNickname: caSigningCert cert-pki-ca
authorityEnabled: TRUE
authorityDN: CN=IPA.LOCAL CA 2017.11.09
description: Host authority</code></pre>
<p>There are now two authority entries when there should be one.
During startup, Dogtag makes sure it has an authority entry for the
main (“host”) CA. It compares the Subject DN from the signing
certificate in its NSSDB to the authority entries. If it doesn’t
find a match it creates a new entry, and that’s what happened here.</p>
<p>The resolution is straightforward:</p>
<ol type="1">
<li>Stop Dogtag</li>
<li>Update the <code>authorityDN</code> and <code>authoritySerial</code> attributes of
the <em>original</em> host authority entry.</li>
<li>Delete the <em>new</em> host authority entry.</li>
<li>Restart Dogtag.</li>
</ol>
<p>Now the previous <code>ldapsearch</code> returns one entry, with the original
authority ID and correct attribute values:</p>
<pre><code>[f27-2:~] ftweedal% ldapsearch -LLL \
    -D 'cn=directory manager' -w DM_PASSWORD \
    -b 'ou=authorities,ou=ca,o=ipaca' -s one
dn: cn=cdbfeb5a-64d2-4141-98d2-98c005802fc1,ou=authorities,ou=ca,o=ipaca
authoritySerial: 11
authorityDN: CN=IPA.LOCAL CA 2017.11.09
objectClass: authority
objectClass: top
cn: cdbfeb5a-64d2-4141-98d2-98c005802fc1
authorityID: cdbfeb5a-64d2-4141-98d2-98c005802fc1
authorityKeyNickname: caSigningCert cert-pki-ca
authorityEnabled: TRUE
description: Host authority</code></pre>
<p>And the operations that were failing before (e.g. <code>ipa ca-show ipa</code>) now succeed. So we’ve confirmed, or restored, the basic
functionality on this server.</p>
<h3 id="ldap-certificate-stores">LDAP certificate stores <a href="#ldap-certificate-stores" class="section">§</a></h3>
<p>There are two LDAP certificate stores in FreeIPA. The first is
<code>cn=ca_renewal,cn=ipa,cn=etc,{basedn}</code>. It is only used for
replicating Dogtag CA and system certificates from the CA renewal
master to CA replicas. The <code>dogtag-ipa-ca-renew-agent</code> Certmonger
helper should update the <code>cn=caSigningCert cert-pki-ca,cn=ca_renewal,cn=ipa,cn=etc,{basedn}</code> entry after
renewing the CA certificate. A quick <code>ldapsearch</code> shows that this
succeeded, so there is nothing else to do here.</p>
<p>The other certificate store is
<code>cn=certificates,cn=ipa,cn=etc,{basedn}</code>. This store contains
trusted CA certificates. FreeIPA clients and servers retrieve
certificates from this directory when updating their certificate
trust stores. Certificates are stored in this container with a
<code>cn</code> based on the Subject DN, except for the IPA CA which is
stored with <code>cn={REALM-NAME} IPA CA</code>. (In my case, this is
<code>cn=IPA.LOCAL IPA CA</code>.)</p>
<p>We discovered the failure to update this certificate store earlier
(in the Certmonger journal). Now we must fix it up. We still want
to trust certificates with the old Issuer DN, otherwise we would
have to reissue <em>all of them</em>. So we need to keep the old CA
certificate in the store, alongside the new.</p>
<p>The process to fix up the certificate store is:</p>
<ol type="1">
<li><p>Export the new CA certificate from the Dogtag NSSDB to a file:</p>
<pre><code>[root@f27-2 ~]# certutil -d /etc/pki/pki-tomcat/alias \
   -L -a -n 'caSigningCert cert-pki-ca' &gt; new-ca.crt</code></pre></li>
<li><p>Add the new CA certificate to the certificate store:</p>
<pre><code>[root@f27-2 ~]# ipa-cacert-manage install new-ca.crt
Installing CA certificate, please wait
CA certificate successfully installed
The ipa-cacert-manage command was successful</code></pre></li>
<li><p>Rename (<code>modrdn</code>) the existing <code>cn={REALM-NAME} IPA CA</code> entry.
The new <code>cn</code> RDN is based on the old CA Subject DN.</p></li>
<li><p>Rename the new CA certificate entry. The current <code>cn</code> is the
new Subject DN. Rename it to <code>cn={REALM-NAME} IPA CA</code>. I
encountered a 389DS attribute uniqueness error when I attempted
to do this as a <code>modrdn</code> operation. I’m not sure why it
happened. To work around the problem I deleted the entry and
added it back with the new <code>cn</code>.</p></li>
</ol>
<p>At the end of this procedure the certificate store is as it should
be. The CA certificate with new Subject DN is installed as
<code>{REALM-NAME} IPA CA</code> and the old CA certificate has been
preserved under a different RDN.</p>
<h3 id="updating-certificate-databases">Updating certificate databases <a href="#updating-certificate-databases" class="section">§</a></h3>
<p>The LDAP certificate stores have the new CA certificate. Now we
need to update the other certificate databases so that the programs
that use them will trust certificates with the new Issuer DN. These
databases include:</p>
<dl>
<dt><code>/etc/ipa/ca.crt</code></dt>
<dd>
<p>CA trust store used by the IPA framework</p>
</dd>
<dt><code>/etc/ipa/nssdb</code></dt>
<dd>
<p>An NSSDB used by FreeIPA</p>
</dd>
<dt><code>/etc/dirsrv/slapd-{REALM-NAME}</code></dt>
<dd>
<p>NSSDB used by 389DS</p>
</dd>
<dt><code>/etc/httpd/alias</code></dt>
<dd>
<p>NSSDB used by Apache HTTPD</p>
</dd>
<dt><code>/etc/pki/ca-trust/source/ipa.p11-kit</code></dt>
<dd>
<p>Adds FreeIPA CA certificates to the system-wide trust store</p>
</dd>
</dl>
<p>Run <code>ipa-certupdate</code> to update these databases with the CA
certificates from the LDAP CA certificate store:</p>
<pre><code>[root@f27-2 ~]# ipa-certupdate
trying https://f27-2.ipa.local/ipa/json
[try 1]: Forwarding 'schema' to json server 'https://f27-2.ipa.local/ipa/json'
trying https://f27-2.ipa.local/ipa/session/json
[try 1]: Forwarding 'ca_is_enabled/1' to json server 'https://f27-2.ipa.local/ipa/session/json'
[try 1]: Forwarding 'ca_find/1' to json server 'https://f27-2.ipa.local/ipa/session/json'
failed to update IPA.LOCAL IPA CA in /etc/dirsrv/slapd-IPA-LOCAL: Command '/usr/bin/certutil -d /etc/dirsrv/slapd-IPA-LOCAL -A -n IPA.LOCAL IPA CA -t C,, -a -f /etc/dirsrv/slapd-IPA-LOCAL/pwdfile.txt' returned non-zero exit status 255.
failed to update IPA.LOCAL IPA CA in /etc/httpd/alias: Command '/usr/bin/certutil -d /etc/httpd/alias -A -n IPA.LOCAL IPA CA -t C,, -a -f /etc/httpd/alias/pwdfile.txt' returned non-zero exit status 255.
failed to update IPA.LOCAL IPA CA in /etc/ipa/nssdb: Command '/usr/bin/certutil -d /etc/ipa/nssdb -A -n IPA.LOCAL IPA CA -t C,, -a -f /etc/ipa/nssdb/pwdfile.txt' returned non-zero exit status 255.
Systemwide CA database updated.
Systemwide CA database updated.
The ipa-certupdate command was successful
[root@f27-2 ~]# echo $?
0</code></pre>
<p><code>ipa-certupdate</code> reported that it was successful and it exited
cleanly. But a glance at the output shows that not all went well.
There were failures added the new CA certificate to several NSSDBs.
Running one of the commands manually to see the command output
doesn’t give us much more information:</p>
<pre><code>[root@f27-2 ~]# certutil -d /etc/ipa/nssdb -f /etc/ipa/nssdb/pwdfile.txt \
    -A -n 'IPA.LOCAL IPA CA' -t C,, -a &lt; ~/new-ca.crt
certutil: could not add certificate to token or database: SEC_ERROR_ADDING_CERT: Error adding certificate to database.
[root@f27-2 ~]# echo $?
255</code></pre>
<p>At this point I guessed that because there is already a certificate
stored with the nickname <code>IPA.LOCAL IPA CA</code>, NSS refuses to add a
certificate with a different Subject DN under the same nickname. So
I will delete the certificates with this nickname from each of the
NSSDBs, then try again. For some reason the nickname appeared twice
in each NSSDB:</p>
<pre><code>[root@f27-2 ~]# certutil -d /etc/dirsrv/slapd-IPA-LOCAL -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

CN=alt-f27-2.ipa.local,O=Example Organization                u,u,u
CN=CA,O=Example Organization                                 C,,
IPA.LOCAL IPA CA                                             CT,C,C
IPA.LOCAL IPA CA                                             CT,C,C</code></pre>
<p>So for each NSSDB, to delete the certificate I had to execute the
<code>certutil</code> command twice. For the 389DS NSSDB, the command was:</p>
<pre><code>[root@f27-2 ~]# certutil -d /etc/httpd/alias -D -n &quot;IPA.LOCAL IPA CA&quot;</code></pre>
<p>The commands for the other NSSDBs were similar. With the
problematic certificates removed, I tried running <code>ipa-certupdate</code>
again:</p>
<pre><code>[root@f27-2 ~]# ipa-certupdate
trying https://f27-2.ipa.local/ipa/session/json
[try 1]: Forwarding 'ca_is_enabled/1' to json server 'https://f27-2.ipa.local/ipa/session/json'
[try 1]: Forwarding 'ca_find/1' to json server 'https://f27-2.ipa.local/ipa/session/json'
Systemwide CA database updated.
Systemwide CA database updated.
The ipa-certupdate command was successful
[root@f27-2 ~]# echo $?
0</code></pre>
<p>This time there were no errors. <code>certutil</code> shows an <code>IPA.LOCAL IPA CA</code> certificate in the database, and it’s the right
certificate:</p>
<pre><code>[root@f27-2 ~]# certutil -d /etc/dirsrv/slapd-IPA-LOCAL -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

CN=alt-f27-2.ipa.local,O=Example Organization                u,u,u
CN=CA,O=Example Organization                                 C,,
CN=Certificate Authority,O=IPA.LOCAL 201711061603            CT,C,C
CN=Certificate Authority,O=IPA.LOCAL 201711061603            CT,C,C
IPA.LOCAL IPA CA                                             C,,
[root@f27-2 ~]# certutil -d /etc/dirsrv/slapd-IPA-LOCAL -L -n 'IPA.LOCAL IPA CA'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 11 (0xb)
        Signature Algorithm: PKCS #1 SHA-256 With RSA Encryption
        Issuer: &quot;CN=Certificate Authority,O=IPA.LOCAL 201711061603&quot;
        Validity:
            Not Before: Thu Nov 09 05:11:12 2017
            Not After : Mon Nov 09 05:11:12 2037
        Subject: &quot;CN=IPA.LOCAL CA 2017.11.09&quot;
        ...</code></pre>
<p>I also confirmed that the old and new CA certificates are present in
the <code>/etc/ipa/ca.crt</code> and <code>/etc/pki/ca-trust/source/ipa.p11-kit</code>
files. So all the certificate databases now include the new CA
certificate.</p>
<h3 id="renewing-the-ca-certificate-again">Renewing the CA certificate (again) <a href="#renewing-the-ca-certificate-again" class="section">§</a></h3>
<p>Observe that (in the self-signed FreeIPA CA case) the Issuer DN of
the new CA certificate is the Subject DN of the old CA certificate.
So we have not quite reached out goal. The original CA certificate
was self-signed, so we want a self-signed certificate with the new
Subject.</p>
<p>Renewing the CA certificate one more time should result in a
self-signed certificate. The current situation is not likely to
result in operational issues. So you can consider this an optional
step. Anyhow, let’s give it a go:</p>
<pre><code>[root@f27-2 ~]# getcert list -i 20171106062742 | egrep 'status|issuer|subject'
        status: MONITORING
        issuer: CN=Certificate Authority,O=IPA.LOCAL 201711061603
        subject: CN=IPA.LOCAL CA 2017.11.09
[root@f27-2 ~]# getcert resubmit -i 20171106062742
Resubmitting &quot;20171106062742&quot; to &quot;dogtag-ipa-ca-renew-agent&quot;.
[root@f27-2 ~]# sleep 5
[root@f27-2 ~]# getcert list -i 20171106062742 | egrep 'status|issuer|subject'
        status: MONITORING
        issuer: CN=IPA.LOCAL CA 2017.11.09
        subject: CN=IPA.LOCAL CA 2017.11.09</code></pre>
<p>Now we have a self-signed CA cert with the new Subject DN. This
step has also confirmed that that the certificate issuance is
working fine with the new CA subject.</p>
<h3 id="renewing-freeipa-service-certificates">Renewing FreeIPA service certificates <a href="#renewing-freeipa-service-certificates" class="section">§</a></h3>
<p>This is another optional step, because we have kept the old CA
certificate in the trust store. I want to check that certificate
renewals via the FreeIPA framework are working, and this is a fine
way to do that.</p>
<p>I’ll renew the HTTP service certificate. This deployment is using
an externally-signed HTTP certificate so first I had to track it:</p>
<pre><code>[root@f27-2 ~]# getcert start-tracking \
  -d /etc/httpd/alias -p /etc/httpd/alias/pwdfile.txt \
  -n 'CN=alt-f27-2.ipa.local,O=Example Organization' \
  -c IPA -D 'f27-2.ipa.local' -K 'HTTP/f27-2.ipa.local@IPA.LOCAL'
New tracking request &quot;20171121071700&quot; added.</code></pre>
<p>Then I resubmitted the tracking request. I had to include the <code>-N &lt;SUBJECT&gt;</code> option because the current Subject DN would be rejected
by FreeIPA. I also had to include the <code>-K &lt;PRINC_NAME&gt;</code> option
due to <a href="https://pagure.io/certmonger/issue/85">a bug in Certmonger</a>.</p>
<pre><code>[root@f27-2 ~]# getcert resubmit -i 20171121073608 \
  -N 'CN=f27-2.ipa.local' \
  -K 'HTTP/f27-2.ipa.local@IPA.LOCAL'
Resubmitting &quot;20171121073608&quot; to &quot;IPA&quot;.
[root@f27-2 ~]# sleep 5
[root@f27-2 ~]# getcert list -i 20171121073608 \
  | egrep 'status|error|issuer|subject'
      status: MONITORING
      issuer: CN=IPA.LOCAL CA 2017.11.09
      subject: CN=f27-2.ipa.local,O=IPA.LOCAL 201711061603</code></pre>
<p>The renewal succeeded, proving that certificate issuance via the
FreeIPA framework is working.</p>
<h2 id="checking-replica-health">Checking replica health <a href="#checking-replica-health" class="section">§</a></h2>
<p>At this point, I’m happy with the state of the FreeIPA server. But
so far I have only dealt with one server in the topology (the
renewal master, whose hostname is <code>f27-2.ipa.local</code>). What about
other CA replicas?</p>
<p>I log onto <code>f27-1.ipa.local</code> (a CA replica). As a first step I
execute <code>ipa-certupdate</code>. This failed in the same was as on the
renewal master, and the steps to resolve were the same.</p>
<p>Next I tell Certmonger to renew the CA certificate. This should not
renew the CA certificate, only retrieve the certificate from the
LDAP certificate store:</p>
<pre><code>[root@f27-1 ~]# getcert list -i 20171106064548 \
  | egrep 'status|error|issuer|subject'
        status: MONITORING
        issuer: CN=Certificate Authority,O=IPA.LOCAL 201711061603
        subject: CN=Certificate Authority,O=IPA.LOCAL 201711061603
[root@f27-1 ~]# getcert resubmit -i 20171106064548
Resubmitting &quot;20171106064548&quot; to &quot;dogtag-ipa-ca-renew-agent&quot;.
[root@f27-1 ~]# sleep 30
[root@f27-1 ~]# getcert list -i 20171106064548 | egrep 'status|error|issuer|subject'
        status: MONITORING
        issuer: CN=Certificate Authority,O=IPA.LOCAL 201711061603
        subject: CN=Certificate Authority,O=IPA.LOCAL 201711061603</code></pre>
<p>Well, that did not work. Instead of retrieving the new CA
certificate from LDAP, the CA replica issued a new certificate:</p>
<pre><code>[root@f27-1 ~]# certutil -d /etc/pki/pki-tomcat/alias -L \
    -n 'caSigningCert cert-pki-ca'
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 268369927 (0xfff0007)
        Signature Algorithm: PKCS #1 SHA-256 With RSA Encryption
        Issuer: &quot;CN=Certificate Authority,O=IPA.LOCAL 201711061603&quot;
        Validity:
            Not Before: Tue Nov 21 08:18:09 2017
            Not After : Fri Nov 06 06:26:21 2037
        Subject: &quot;CN=Certificate Authority,O=IPA.LOCAL 201711061603&quot;
        ...</code></pre>
<p>This was caused by the first problem we faced when renewing the CA
certificate with a new Subject DN. Once again, a mismatch between
the Subject DN in the CSR and the FreeIPA CA’s Subject DN has
confused the renewal helper.</p>
<p>The resolution in this case is to delete all the certificates with
nickname <code>caSigningCert cert-pki-ca</code> or <code>IPA.LOCAl IPA CA</code> from
Dogtag’s NSSDB then add the new CA certificate to the NSSDB. Then
run <code>ipa-certupdate</code> again. Dogtag must not be running during
this process:</p>
<pre><code>[root@f27-1 ~]# systemctl stop pki-tomcatd@pki-tomcat
[root@f27-1 ~]# cd /etc/pki/pki-tomcat/alias
[root@f27-1 ~]# certutil -d . -D -n 'caSigningCert cert-pki-ca'
[root@f27-1 ~]# certutil -d . -D -n 'caSigningCert cert-pki-ca'
[root@f27-1 ~]# certutil -d . -D -n 'caSigningCert cert-pki-ca'
[root@f27-1 ~]# certutil -d . -D -n 'caSigningCert cert-pki-ca'
certutil: could not find certificate named &quot;caSigningCert cert-pki-ca&quot;: SEC_ERROR_BAD_DATABASE: security library: bad database.
[root@f27-1 ~]# certutil -d . -D -n 'IPA.LOCAL IPA CA'
[root@f27-1 ~]# certutil -d . -D -n 'IPA.LOCAL IPA CA'
[root@f27-1 ~]# certutil -d . -D -n 'IPA.LOCAL IPA CA'
certutil: could not find certificate named &quot;IPA.LOCAL IPA CA&quot;: SEC_ERROR_BAD_DATABASE: security library: bad database.
[root@f27-1 ~]# certutil -d . -A \
    -n 'caSigningCert cert-pki-ca' -t 'CT,C,C' &lt; /root/ipa-ca.pem
[root@f27-1 ~]# ipa-certupdate
trying https://f27-1.ipa.local/ipa/json
[try 1]: Forwarding 'ca_is_enabled' to json server 'https://f27-1.ipa.local/ipa/json'
[try 1]: Forwarding 'ca_find/1' to json server 'https://f27-1.ipa.local/ipa/json'
Systemwide CA database updated.
Systemwide CA database updated.
The ipa-certupdate command was successful
[root@f27-1 ~]# systemctl start pki-tomcatd@pki-tomcat</code></pre>
<p>Dogtag started without issue and I was able to issue a certificate
via the <code>ipa cert-request</code> command on this replica.</p>
<h2 id="discussion">Discussion <a href="#discussion" class="section">§</a></h2>
<p>It took a while and required a lot of manual effort, but I reached
the goal of changing the CA Subject DN. The deployment seems to be
operational, although my testing was not exhaustive and there may be
breakage that I did not find.</p>
<p>One of the goals was to define the process for both self-signed and
externally-signed CAs. I did not deal with the externally-signed CA
case. This article (and the process of writing it) was long enough
without it! But much of the process, and problems encountered, will
be the same.</p>
<p>There are some important concerns and caveats to be aware of.</p>
<p>First, CRLs generated after the Subject DN change may be bogus.
They will be issued by the new CA but will contain serial numbers of
revoked certificates that were issued by the old CA. Such
assertions are invalid but not harmful in practice because those
serial numbers will never be reused with the new CA. This is an
implementation detail of Dogtag and not true in general.</p>
<p>But there is a bigger problem related to CRLs. After the CA name
change, the old CA will never issue another CRL. This means that
revoked certificates with the old Issuer DN will never again appear
on a CRL issued by the old CA. Worse, the Dogtag OCSP responder
errors when you query the status of a certificate with the old
Issuer DN. In sum, this means that there is no way for Dogtag to
revoke a certificate with the old Issuer DN. Because many systems
<em>“fail open”</em> in the event of missing or invalid CRLs or OCSP
errors, this is a potentially <strong>severe security issue</strong>.</p>
<p>Changing a FreeIPA installation’s CA Subject DN, whether by the
procedure outlined in this post or by any other, is <strong>unsupported</strong>.
If you try to do it and break your installation, we (the FreeIPA
team) may try to help you recover, to a point. But we can’t
guarantee anything. <em>Here be dragons</em> and all that.</p>
<p>If you think you need to change your CA Subject DN and have not read
the <a href="2017-11-20-changing-ca-subject-dn-part-i.html">previous post</a> on this topic, please go and read it. It
proposes some alternatives that, if applicable, avoid the messy
process and security issues detailed here. Despite showing you how
to change a FreeIPA installation’s CA Subject DN, my advice remains:
<strong>don’t do it</strong>. I hope you will heed it.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2023-01-22-openshift-feature-gates.html">Enabling Kubernetes feature gates in OpenShift</a>
        </li>
    
        <li>
            <a href="../posts/2022-08-29-jax-rs-header-formatting.html">Controlling header formatting in JAX-RS applications</a>
        </li>
    
        <li>
            <a href="../posts/2022-03-24-k8s-external-dns.html">Experimenting with ExternalDNS</a>
        </li>
    
        <li>
            <a href="../posts/2022-02-02-openshift-user-ns-without-anyuid.html">Running Pods in user namespaces without privileged SCCs</a>
        </li>
    
        <li>
            <a href="../posts/2021-11-18-k8s-tcp-udp-ingress.html">Bare TCP and UDP ingress on Kubernetes</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
