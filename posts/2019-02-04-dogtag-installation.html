<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - How does Dogtag PKI spawn?</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a href="../tags/dogtag.html">dogtag</a>, <a href="../tags/internals.html">internals</a>
    
</div>

<div id="postContent">
    <h1 id="how-does-dogtag-pki-spawn">How does Dogtag PKI spawn?</h1>
<p>Dogtag PKI is a complex program. Anyone who has performed a standalone installation of Dogtag can attest to this (to say nothing of actually using it). The program you invoke to install Dogtag is called <code>pkispawn(8)</code>. When installing standalone, you invoke <code>pkispawn</code> directly. When FreeIPA installs a Dogtag instance, it invokes <code>pkispawn</code> behind the scenes.</p>
<p>So what does <code>pkispawn</code> actually <em>do</em>? In this post I’ll explain how <code>pkispawn</code> actually spawns a Dogtag instance. This post is not intended to be a guide to the many configuration options <code>pkispawn</code> knows about (although we’ll cover several). Rather, I’ll explain the actions <code>pkispawn</code> performs (or causes to be performed) to go from a fresh system to a working Dogtag CA instance.</p>
<p>This post is aimed at developers and support associates, and to a lesser extent, people who are trying to diagnose issues themselves or understand how to accomplish something fancy in their Dogtag installation. By explaining the steps involved in spawning a Dogtag instance, I hope to make it easier for readers to diagnose issues or implement fixes or enhancements.</p>
<h2 id="pkispawn-overview"><code>pkispawn</code> overview</h2>
<p><code>pkispawn(8)</code> is provided by the <code>pki-server</code> RPM (which is required by the <code>pki-ca</code> RPM that provides the CA subsystem).</p>
<p>You can invoke <code>pkispawn</code> without arguments, and it will prompt for the minimal data it needs to continue. These data include the subsystem to install (e.g. <code>CA</code> or <code>KRA</code>), and LDAP database connection details. For a fresh installation, most defaults are acceptable.</p>
<p>There are many ways to configure or customise an installation. A few important scenarios are:</p>
<ul>
<li>installing a <code>KRA</code>, <code>OCSP</code>, <code>TKS</code> or <code>TPS</code> subsystem associated with the existing <code>CA</code> subsystem (typically on the same machine as the <code>CA</code> subsystem).</li>
<li>installing a <em>clone</em> of a subsystem (typically on a different machine)</li>
<li>installing a CA subsystem with an externally-signed CA certificate</li>
<li>non-interactive installation</li>
</ul>
<p>For the above scenarios, and for many other possible variations, it is necessary to give <code>pkispawn</code> a configuration file. The <code>pki_default.cfg(5)</code> man page describes the format and available options. Some options are relevant to all subsystems, and others are subsystem-specific (i.e. only for <code>CA</code>, or <code>KRA</code>, etc.) Here is a basic configuration:</p>
<pre><code>[DEFAULT]
pki_server_database_password=Secret.123

[CA]
pki_admin_email=caadmin@example.com
pki_admin_name=caadmin
pki_admin_nickname=caadmin
pki_admin_password=Secret.123
pki_admin_uid=caadmin

pki_client_database_password=Secret.123
pki_client_database_purge=False
pki_client_pkcs12_password=Secret.123

pki_ds_base_dn=dc=ca,dc=pki,dc=example,dc=com
pki_ds_database=ca
pki_ds_password=Secret.123

pki_security_domain_name=EXAMPLE

pki_ca_signing_nickname=ca_signing
pki_ocsp_signing_nickname=ca_ocsp_signing
pki_audit_signing_nickname=ca_audit_signing
pki_sslserver_nickname=sslserver
pki_subsystem_nickname=subsystem</code></pre>
<p>The <code>-f</code> option tells <code>pkispawn</code> the configuration file to use. <code>-s CA</code> tell it install the CA subsystem.</p>
<pre><code>$ pkispawn -f ca.cfg -s CA</code></pre>
<p>For many more examples of how to install Dogtag subsystems for particular scenarios, see the <a href="https://www.dogtagpki.org/wiki/PKI_10_Installation">PKI 10 Installation guide</a> on the Dogtag wiki.</p>
<h2 id="terminology">Terminology</h2>
<p>It is worthwhile to clarify the meaning of some terms:</p>
<dl>
<dt><em>instance</em> or <em>installation</em></dt>
<dd><p>An installation of Dogtag on a particular machine. An instance may contain one or more <em>subsystems</em>. There may be more than one Dogtag instance on a single machine, although this is uncommon (and each instance must use a disjoint set of network ports). The default instance name is <code>pki-tomcat</code>.</p>
</dd>
<dt><em>subsystem</em></dt>
<dd><p>Each main function in Dogtag is provided by a subsystem. The subsystems are: <code>CA</code>, <code>KRA</code>, <code>OCSP</code>, <code>TKS</code> and <code>TPS</code>. Every Dogtag instance must have a <code>CA</code> subsystem (hence, the first subsystem installed must be the <code>CA</code> subsystem).</p>
</dd>
<dt><em>clone</em></dt>
<dd><p>For redundancy, a subsystem may be <em>cloned</em> to a different instance (usually on a different machine; this is not a technical requirement but it does not make sense to do otherwise). Different subsystems may have different numbers of clones in a topology.</p>
</dd>
<dt><em>topology</em> or <em>deployment</em></dt>
<dd><p>All of the clones of all subsystems derived from some original CA subsystem form a <em>deployment</em> or <em>topology</em>. Typically, each <em>instance</em> in the topology would have a replicated copy of the LDAP database.</p>
</dd>
</dl>
<h2 id="pkispawn-implementation"><code>pkispawn</code> implementation</h2>
<h3 id="two-main-phases">Two main phases</h3>
<p><code>pkispawn</code> has two main phases:</p>
<ol type="1">
<li>set up the Tomcat server and Dogtag application</li>
<li>send <em>configuration requests</em> to the Dogtag application, which performs further configuration steps.</li>
</ol>
<p>(This is not to be confused with a <em>two step</em> externally-signed CA installation.)</p>
<p>Of course there are many more steps than this. But there is an important reasons I am making such a high-level distinction: debugging. In the first phase <code>pkispawn</code> does everything. Any errors will show up in the <code>pkispawn</code> log file (<code>/var/log/pki/pki-&lt;subsystem&gt;-&lt;timestamp&gt;.log</code>). It is usually straightforward to work out what failed. <em>Why</em> it failed is sometimes easy to work out, and sometimes not so easy.</p>
<p>But in the second phase, <code>pkispawn</code> is handing over control to Dogtag to finish configuring itself. <code>pkispawn</code> sends a series of requests to the <code>pki-tomcatd</code> web application. These requests tell Dogtag to configure things like the database, security domain, and so on. If something goes wrong during these steps, you <em>might</em> see something useful in the <code>pkispawn</code> log, but you will probably also need to look at the Dogtag <code>debug</code> log, or even the Tomcat or Dogtag logs of another subsystem or clone. I detailed this (in the context of debugging clone installation failures) in <a href>a previous post</a>.</p>
<h3 id="scriptlets">Scriptlets</h3>
<p><code>pkispawn</code> is implemented in Python. The various steps of installation are implemented as <em>scriptlets</em>: small subroutines that take care of one part of the installation. These are:</p>
<ol type="1">
<li><code>initialization</code>: sanity check and normalise installer configuration, and sanity check the system environment.</li>
<li><code>infrastructure_layout</code>: create PKI instance directories and configuration files.</li>
<li><code>instance_layout</code>: lay out the Tomcat instance and configuration files (skipped when spawning a second subsystem on an existing instance).</li>
<li><code>subsystem_layout</code>: lay out subsystem-specific files and directories.</li>
<li><code>webapp_deployment</code>: deploy the Tomcat web application.</li>
<li><code>security_databases</code>: set up the main Dogtag NSS database, and a client database where the administrator key and certificate will be created.</li>
<li><code>selinux_setup</code>: establish correct SELinux contexts on instance and subsystem files.</li>
<li><code>keygen</code>: generate keys and CSRs for the subsystem (for the CA subsystem, this inclues the CA signing key and CSR for external signing).</li>
<li><code>configuration</code>: For external CA installation, import the externally-signed CA certificate and chain. (Re)start the <code>pki-tomcatd</code> instance and send configuration requests to the Java application. The whole second phase discussed in the previous section occurs here. It will be discussed in more detail in the next section.</li>
<li><code>finalization</code>: enable PKI to start on boot (by default) and optionally purge client NSS databases that were set up during installation.</li>
</ol>
<p>For a two-step externally-signed CA installation, the <code>configuration</code> and <code>finalization</code> scriptlets are skipped during step 1, and in step 2 the scriptlets up to and including <code>keygen</code> are skipped. (A bit of hand-waving here; they not not really skipped but return early).</p>
<p>In the codebase, scriptlets are located under <code>base/server/python/pki/server/deployment/scriptlets/&lt;name&gt;.py</code>. The list of scriptlets and the order in which they’re run is given by the <code>spawn_scriplets</code> variable in <code>base/server/etc/default.cfg</code>. Note that <code>scriplet</code> there is not a typo. Or maybe it is, but it’s not <em>my</em> typo. In some parts of the codebase, we say <em>scriplet</em>, and in others it’s <em>scriptlet</em>. This is mildly annoying, but you just have to be careful to use the correct class or variable name.</p>
<p>Some other Python files contain a lot of code used during deployment. It’s not reasonable to make an exhaustive list, but <code>pki.server.deployment.pkihelper</code> and <code>pki.server.deployment.pkiparser</code> in particular include a lot of configuration processing code. If you are implementing or changing <code>pkispawn</code> configuration options, you’ll be defining them and following changes around in these files (and possibly others), as well as in <code>base/server/etc/default.cfg</code>.</p>
<h4 id="scriptlets-and-uninstallation">Scriptlets and uninstallation</h4>
<p>The installation scriptlets also implement corresponding uninstallation behaviours. When uninstalling a Dogtag instance or subsystem via the <code>pkidestroy</code> command, each scriptlets’ uninstallation behaviour is invoked. The order in which they’re invoked is different from installation, and is given by the <code>destroy_scriplets</code> variable in <code>base/server/etc/default.cfg</code>.</p>
<h3 id="configuration-requests">Configuration requests</h3>
<p>The <code>configuration</code> scriptlet sends a series of configuration requests to the Dogtag web API. Each request causes Dogtag to perform specific configuration behaviour(s). Depending on the subsystem being installed and whether it is a clone, these steps may including communication with other subsystems or instances, and/or the LDAP database.</p>
<p>The requests performed, in order, are:</p>
<ol type="1">
<li><code>/rest/installer/configure</code>: configure (but don’t yet create) the security domain. Import and verify certificates. If creating a clone, request number range allocations from the master.</li>
<li><code>/rest/installer/setupDatabase</code>: add database connection configuration to <code>CS.cfg</code>. Enable required DS plugins. Populate the database. If creating a clone, initialise replication (this can be suppressed if replication is managed externally, as is the case for FreeIPA in Domain Level 1). Populate VLV indices.</li>
<li><code>/rest/installer/configureCerts</code>: configure system certificates, generating keys and issuing certificates where necessary.</li>
<li><code>/rest/installer/setupAdmin</code> (skipped for clones): create admin user and issue certificate.</li>
<li><code>/rest/installer/backupKeys</code> (optional): back up system certificates and keys to a PKCS #12 file.</li>
<li><code>/rest/installer/setupSecurityDomain</code>: create the security domain data in LDAP (non-clone) or add the new clone to the security domain.</li>
<li><code>/rest/installer/setupDatabaseUser</code>: set up the LDAP database user, including certificate (if configured). This is the user that Dogtag uses to bind to LDAP.</li>
<li><code>/rest/installer/finalizeConfiguration</code>: remove <em>preop</em> configuration entries (which are only used during installation) and perform other finalisation in <code>CS.cfg</code>.</li>
</ol>
<p>For all of these requests, the <code>configuration</code> scriptlet builds the request data according to the <code>pkispawn</code> configuration. Then it sends the request to the current hostname. Communications between <code>pkispawn</code> and Tomcat are unlikely to fail (connection failure would suggest a major network configuration problem).</p>
<p>If something goes wrong during processing of the request, errors should appear in the subsystem debug log (<code>/etc/pki/pki-tomcat/ca/debug.YYYY-MM-DD.log</code>; <code>/etc/pki/pki-tomcat/ca/debug</code> on older versions), or the system journal. If the local system had to contact other subsystems or instances on other hosts, it may be necessary to look at the debug logs, system journal or Tomcat / Apache httpd logs of the relevant host / subsystem. I wrote about this at length in <a href>a previous post</a> so I won’t say more about it here.</p>
<p>In terms of the code, the resource paths and servlet interface are defined in <code>com.netscape.certsrv.system.SystemConfigResource</code>. The implementation is in <code>com.netscape.certsrv.system.SystemConfigService</code>, with a considerable amount of behaviour residing as helper methods in <code>com.netscape.cms.servlet.csadmin.ConfigurationUtils</code>. If you are investigating or fixing configuration request failures, you will spend a fair bit of time grubbing around in these classes.</p>
<h2 id="conclusion">Conclusion</h2>
<p>As I have shown in this post, spawning a Dogtag PKI instance involves a lot of steps. There are many, <em>many</em> ways to customise the installation and I have glossed over many details. But my aim in this post was not to be a comprehensive reference guide or how-to. Rather the intent was to give a high-level view of what happens during installation, and how those behaviours are implemented. Hopefully I have achieved that, and as a result you are now able to more easily diagnose issues or implement changes or features in the Dogtag installer.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2019-02-28-dogtag-cert-fix.html">Offline expired certificate renewal for Dogtag</a>
        </li>
    
        <li>
            <a href="../posts/2019-02-18-freeipa-san-ip.html">IP address SAN support in FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2019-02-07-staticmethod-considered-beneficial.html"><code>staticmethod</code> considered beneficial</a>
        </li>
    
        <li>
            <a href="../posts/2019-02-04-dogtag-installation.html">How does Dogtag PKI spawn?</a>
        </li>
    
        <li>
            <a href="../posts/2019-01-29-name-constraints.html">X.509 Name Constraints and FreeIPA</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
