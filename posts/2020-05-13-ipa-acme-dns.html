<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - ACME DNS challenges and FreeIPA</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'acme'." href="../tags/acme.html" rel="tag">acme</a>, <a title="All pages tagged 'freeipa'." href="../tags/freeipa.html" rel="tag">freeipa</a>, <a title="All pages tagged 'certificates'." href="../tags/certificates.html" rel="tag">certificates</a>, <a title="All pages tagged 'dns'." href="../tags/dns.html" rel="tag">dns</a>
    
</div>

<div id="postContent">
    <h1 id="acme-dns-challenges-and-freeipa">ACME DNS challenges and FreeIPA</h1>
<p><em>This post is part of a series of ACME client demonstrations. See
also the posts about</em>
<a href="2020-05-06-ipa-acme-intro.html">Certbot standalone HTTP</a>
<em>and</em>
<a href="2020-05-07-ipa-acme-mod_md.html">mod_md for Apache</a></p>
<p>The ACME protocol defined in <a href="https://tools.ietf.org/html/rfc8555">RFC 8555</a> defines a <a href="https://tools.ietf.org/html/rfc8555#section-8.4">DNS challenge</a>
for proving control of a domain name. In this post I’ll explain how
the DNS challenge works and demonstrate how to use the <a href="https://certbot.eff.org/">Certbot</a> ACME
client with the FreeIPA integrated DNS service.</p>
<h2 id="the-dns-challenge">The DNS challenge <a href="#the-dns-challenge" class="section">§</a></h2>
<p>To prove control of a domain name (the <code>dns</code> identifier type) ACME
defines the <code>dns-01</code> challenge type. It is up to ACME servers
which challenges to create for a given identifier. If a server
offers multiple challenges (e.g. <code>http-01</code> and <code>dns-01</code>) the
client can choose which one to attempt.</p>
<p>A DNS challenge object looks like:</p>
<pre><code>{
  &quot;type&quot;: &quot;dns-01&quot;,
  &quot;url&quot;: &quot;https://example.com/acme/chall/Rg5dV14Gh1Q&quot;,
  &quot;status&quot;: &quot;pending&quot;,
  &quot;token&quot;: &quot;evaGxfADs6pSRb2LAv9IZf17Dt3juxGJ-PCt92wr-oA&quot;
}</code></pre>
<p>The <code>token</code> field is a base64url-encoded high-entropy random
value. Due to the use of TLS this value should be known only to the
server and client.</p>
<p>The client responds to a <code>dns-01</code> challenge by provisioning a DNS
<strong>TXT</strong> record containing the SHA-256 digest of the <em>key
authorisation</em> value, which is the concatenation of the <code>token</code>
value from the challenge object and the JWK Thumbprint of the
account key. For example:</p>
<pre><code>_acme-challenge.www.example.org. 300 IN TXT &quot;gfj9Xq...Rg85nM&quot;</code></pre>
<p>The client then informs the ACME server that it can validate the
challenge:</p>
<pre><code>POST /acme/chall/Rg5dV14Gh1Q
Host: example.com
Content-Type: application/jose+json

{
  &quot;protected&quot;: base64url({
    &quot;alg&quot;: &quot;ES256&quot;,
    &quot;kid&quot;: &quot;https://example.com/acme/acct/evOfKhNU60wg&quot;,
    &quot;nonce&quot;: &quot;SS2sSl1PtspvFZ08kNtzKd&quot;,
    &quot;url&quot;: &quot;https://example.com/acme/chall/Rg5dV14Gh1Q&quot;
  }),
  &quot;payload&quot;: base64url({}),
  &quot;signature&quot;: &quot;Q1bURgJoEslbD1c5...3pYdSMLio57mQNN4&quot;
}</code></pre>
<p>The ACME server will query the DNS. When it sees that the expected
TXT record, the challenge (and corresponding identifier
authorisation) are completed.</p>
<p>Because DNSSEC is not widely deployed, ACME servers can mitigate
against DNS-based attacks by querying DNS from mutiple vantage
points. This increases attack cost and complexity.</p>
<h2 id="dns-and-certbot">DNS and Certbot <a href="#dns-and-certbot" class="section">§</a></h2>
<p>Certbot provides the <code>--preferred-challenges={dns,http}</code> CLI
option to specify which challenge type to prefer if the server
offers multiple challenges.</p>
<p>There are several <a href="https://certbot.eff.org/docs/using.html#dns-plugins">DNS plugins</a> available for using Certbot with
particular DNS services. For example there are plugins for
Cloudflare, Route53 and many other services. At a glance, many of
them are packaged for Fedora. Each DNS plugin has different options
to activate and configure it. Because we are not using any of these
services I won’t go into further details here.</p>
<p>Certbot also provides <a href="https://certbot.eff.org/docs/using.html#pre-and-post-validation-hooks">pre and post validation hooks</a> for the
<code>--manual</code> strategy. These let the user specify scripts to carry
out challenge provisioning and cleanup steps. The command line
options are <code>--manual-auth-hook</code> and <code>--manual-cleanup-hook</code>.</p>
<h2 id="certbot-and-freeipa-dns">Certbot and FreeIPA DNS <a href="#certbot-and-freeipa-dns" class="section">§</a></h2>
<p>You can use the CLI options described above to implement arbitrary
means of responding to ACME challenges. And I have done just that
for responding to the <code>dns-01</code> challenge using the FreeIPA
integrated DNS service.</p>
<p>The FreeIPA integrated DNS is an optional component of FreeIPA. It
is implmented using the BIND DNS server and a database plugin
causing BIND to read from the FreeIPA replicated LDAP database. The
DNS service can be installed at server install time, or afterwards
via the <code>ipa-dns-install</code> command. The <code>freeipa-server-dns</code>
(Fedora) or <code>ipa-server-dns</code> (RHEL) package provides this feature.
The rest of this section assumes that the FreeIPA integrated DNS
server is installed and FreeIPA-enrolled client machines are
configured to use it.</p>
<p>The <code>ipa dnsrecord-add &lt;zone&gt; &lt;name&gt; ...</code> command adds record(s)
to the zone. The resource types and values are given in options
like <code>--aaaa-rec=&lt;ip6addr&gt;</code> or <code>--txt-rec=&lt;string&gt;</code>. The
corresponding command <code>dnsrecord-del</code> command has the same format.
Knowing that we can also interact with the FreeIPA server via the
<code>ipalib</code> Python library, we have everything we need to implement
the Certbot hook script(s) that will use FreeIPA’s DNS to satisfy
the ACME <code>dns-01</code> challenge.</p>
<h3 id="hook-script">Hook script <a href="#hook-script" class="section">§</a></h3>
<p>The script is so short I will just include the whole thing here.
I have broken it into chunks with commentary.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python3</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dns <span class="im">import</span> resolver</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipalib <span class="im">import</span> api </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ipapython <span class="im">import</span> dnsutil</span></code></pre></div>
<p>Shebang, imports. Trivial.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>certbot_domain <span class="op">=</span> os.environ[<span class="st">'CERTBOT_DOMAIN'</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>certbot_validation <span class="op">=</span> os.environ[<span class="st">'CERTBOT_VALIDATION'</span>]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'CERTBOT_AUTH_OUTPUT'</span> <span class="kw">in</span> os.environ:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    command <span class="op">=</span> <span class="st">'dnsrecord_del'</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    command <span class="op">=</span> <span class="st">'dnsrecord_add'</span></span></code></pre></div>
<p>Certbot provides the domain name and the <em>authorisation string</em> via
environment variables. In the cleanup phase it also sets the
<code>CERTBOT_AUTH_OUTPUT</code> environment variable. Therefore I use this
same script for both the authorisation and cleanup phases. Because
the commands are so similar, the only thing that changes during
cleanup is the command name.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>validation_domain <span class="op">=</span> <span class="ss">f'_acme-challenge.</span><span class="sc">{</span>certbot_domain<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>fqdn <span class="op">=</span> dnsutil.DNSName(validation_domain).make_absolute()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>zone <span class="op">=</span> dnsutil.DNSName(resolver.zone_for_name(fqdn))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> fqdn.relativize(zone)</span></code></pre></div>
<p>Construct the validation domain name and find the corresponding DNS
zone, i.e. the zone in which we must create the TXT record. Then we
relativise the validation domain name against the zone.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>api.bootstrap(context<span class="op">=</span><span class="st">'cli'</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>api.finalize()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>api.Backend.rpcclient.<span class="ex">connect</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>api.Command[command](</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  zone,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  name,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  txtrecord<span class="op">=</span>[certbot_validation],</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  dnsttl<span class="op">=</span><span class="dv">60</span>)</span></code></pre></div>
<p>Initialise the API and execute the command. Note that names of the
keyword arguments are different from the corresponding CLI options.</p>
<p>There are some important <strong>caveats</strong>. There must be latent,
non-expired Kerberos credentials in the execution environment.
These can be in the default credential cache or specified via the
<code>KRB5CCNAME</code> environment variable (e.g. to point to a keytab
file). The principal must also have permissions to add and remove
DNS records.</p>
<h2 id="demo">Demo <a href="#demo" class="section">§</a></h2>
<p>As in previous ACME demos the client machine is enrolled as a
FreeIPA client and trusts the FreeIPA CA. For this demo Certbot
does not need to run as <code>root</code>. But by default Certbot tries to
read and write files under <code>/etc/letsencrypt</code>. I had to override
this behaviour with the following command line options:</p>
<dl>
<dt><code>--config-dir DIR</code></dt>
<dd>
<p>Configuration directory. (default: <code>/etc/letsencrypt</code>)</p>
</dd>
<dt><code>--work-dir DIR</code></dt>
<dd>
<p>Working directory. (default: <code>/var/lib/letsencrypt</code>)</p>
</dd>
<dt><code>--logs-dir LOGS_DIR</code></dt>
<dd>
<p>Logs directory. (default: <code>/var/log/letsencrypt</code>)</p>
</dd>
</dl>
<p>I defined these options in a shell array variable for use in
subsequent commands. I included the ACME server configuration too:</p>
<pre><code>[f31-0:~] ftweedal% CERTBOT_ARGS=( 
array&gt; --logs-dir ~/certbot/log
array&gt; --work-dir ~/certbot/work
array&gt; --config-dir ~/certbot/config
array&gt; --server https://ipa-ca.ipa.local/acme/directory
array&gt; )</code></pre>
<p>Next I registered an account:</p>
<pre><code>[f31-0:~] ftweedal% certbot $CERTBOT_ARGS \
    register --email ftweedal@redhat.com \
    --agree-tos --no-eff-email --quiet
Saving debug log to /home/ftweedal/certbot/log/letsencrypt.log

IMPORTANT NOTES:
 - Your account credentials have been saved in your Certbot
   configuration directory at /home/ftweedal/certbot/config. You
   should make a secure backup of this folder now. This configuration
   directory will also contain certificates and private keys obtained
   by Certbot so making regular backups of this folder is ideal.</code></pre>
<p>The <code>--no-eff-email</code> option suppressed the <em>“Would you be willing
to share your email address with the Electronic Frontier
Foundation?”</em> prompt.</p>
<p>The FreeIPA hook script requires Kerberos credentials so I executed
<code>kinit admin</code>. <strong>In production use a less privileged account</strong>
with permissions to add and delete DNS records.</p>
<pre><code>[f31-0:~] ftweedal% kinit admin
Password for admin@IPA.LOCAL: XXXXXXXX</code></pre>
<p>Now I was ready to request the certificate. Alongside executing
<code>certbot</code>, in another terminal I executed DNS queries to observe
the creation and deletion of the TXT record.</p>
<pre><code>[root@f31-0 ~]# certbot $CERTBOT_ARGS \
    certonly --domain $(hostname) \
    --key-type rsa \
    --preferred-challenges dns \
    --manual --manual-public-ip-logging-ok \
    --manual-auth-hook /home/ftweedal/certbot-dns-ipa.py \
    --manual-cleanup-hook /home/ftweedal/certbot-dns-ipa.py
Saving debug log to /home/ftweedal/certbot/log/letsencrypt.log 
Plugins selected: Authenticator manual, Installer None                                                            
Obtaining a new certificate                                                                                       
Performing the following challenges:
dns-01 challenge for f31-0.ipa.local
Running manual-auth-hook command: /home/ftweedal/certbot-dns-ipa.py
Waiting for verification...
Cleaning up challenges
Running manual-cleanup-hook command: /home/ftweedal/certbot-dns-ipa.py

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /home/ftweedal/certbot/config/live/f31-0.ipa.local/fullchain.pem
   Your key file has been saved at:
   /home/ftweedal/certbot/config/live/f31-0.ipa.local/privkey.pem
   Your cert will expire on 2020-08-11. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   &quot;certbot renew&quot;
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le</code></pre>
<p>The certificate was issued and the process took about 10 seconds.
In the other terminal, running <code>dig</code> every couple of seconds let
me observe the TXT record that was created and then deleted:</p>
<pre><code>[f31-0:~] ftweedal% dig +short TXT _acme-challenge.f31-0.ipa.local

[f31-0:~] ftweedal% dig +short TXT _acme-challenge.f31-0.ipa.local
&quot;5qkVb3ykx8nRdJOKbKf-xDtoySFl-B2W37bBBOHGoyc&quot;

[f31-0:~] ftweedal% dig +short TXT _acme-challenge.f31-0.ipa.local
&lt;&lt; no output; record is gone &gt;&gt;</code></pre>
<h2 id="error-handling">Error handling <a href="#error-handling" class="section">§</a></h2>
<p>To my surprise, a failure (non-zero exit status) of the
authorisation hook script <em>does not</em> cause Certbot to halt. For
example, after deleting my credential cache with <code>kdestroy</code> and
running <code>certbot</code> with the same options as above, Certbot output
an error message and the standard error output from the hook
script:</p>
<pre><code>...
Running manual-auth-hook command: /home/ftweedal/certbot-dns-ipa.py                                               
manual-auth-hook command &quot;/home/ftweedal/certbot-dns-ipa.py&quot;
returned error code 1                                
Error output from manual-auth-hook command certbot-dns-ipa.py:                                                    
Traceback (most recent call last):                                                                                
  File &quot;/usr/lib/python3.7/site-packages/ipalib/rpc.py&quot;, line 647,
  in get_auth_info                               
      response = self._sec_context.step()                                          
  ...</code></pre>
<p>Nevertheless Certbot proceeded to indicating to the server that the
challenge is ready for verification:</p>
<pre><code>Waiting for verification...                                                                                       
&lt; 20 seconds elapse &gt;</code></pre>
<p>It then cleaned up the challenges and ran the cleanup hook (which
also failed, as expected, due to no Kerberos credentials):</p>
<pre><code>Cleaning up challenges   
Cleaning up challenges                                                                                            
Running manual-cleanup-hook command: /home/ftweedal/certbot-dns-ipa.py
manual-cleanup-hook command &quot;/home/ftweedal/certbot-dns-ipa.py&quot; returned error code 1                             
Error output from manual-cleanup-hook command certbot-dns-ipa.py:                                                 
Traceback (most recent call last):   
  ...</code></pre>
<p>Finally it output the error from the ACME service:</p>
<pre><code>An unexpected error occurred:                                                                                     
There was a problem with a DNS query during identifier validation ::
  Unable to validate DNS-01 challenge at _acme-challenge.f31-0.ipa.local                                                                                         
Error: DNS name not found [response code 3]                                                                       
Please see the logfiles in /home/ftweedal/certbot/log for more details. </code></pre>
<p>Responding to a challenge after an abnormal exit of the
authorisation hook seems to infringe RFC 8555 §8.2 which states:</p>
<blockquote>
<p>Clients SHOULD NOT respond to challenges until they believe that
the server’s queries will succeed.</p>
</blockquote>
<p>I <a href="https://github.com/certbot/certbot/issues/7990">reported this issue</a> against the Certbot GitHub repository.</p>
<h2 id="discussion">Discussion <a href="#discussion" class="section">§</a></h2>
<p>The <code>certbot-dns-ipa.py</code> script is <a href="https://gist.github.com/frasertweedale/ca42ff31d5f5b8d3c6d4d3a94f9fbd0e">available in a Gist</a>. It is
trivial so consider it public domain.</p>
<p>The script is an artifact of work that is partly an exploration of
ACME use cases, and partly for verifying the PKI and FreeIPA ACME
services. I encountered no issues on the ACME server side which was
pleasing.</p>
<p>From the client point of view it was good to confirm that what
<em>sounded</em> like a valid use case was indeed valid. Not only that, it
was straightforward thanks to the FreeIPA Python API and the design
of the DNS plugin. The success of this use case exploration leads
to to a couple of related questions:</p>
<ul>
<li>Should we build a “proper” Certbot plugin for FreeIPA DNS?</li>
<li>Should we distribute and support the manual hook script?</li>
</ul>
<p>These questions don’t need answers today. But it is good to outline
and compare the options.</p>
<p>From a technical standpoint these are not mutually exclusive; you
could do both. But from a usage standpoint you only really need one
or the other. A proper plugin might have better UX and
discoverability but it would be additional work (how much more I’m
not sure yet). On the other hand the hook script is pretty much
already “done”. We would just need to distribute it, e.g. install
it under <code>/usr/libexec/ipa/</code>.</p>
<p>This post concludes my “trilogy” of ACME client use case demos. In
the future I will probably explore the intersection of ACME,
OpenShift and FreeIPA. If so, expect the “sequel trilogy”. But my
immediate focus must be to finish the FreeIPA ACME service and get
it merged upstream.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2023-02-02-freeipa-pkinit-certmap-vuln.html">CVE-2022-4254: FreeIPA PKINIT certificate mapping vulnerability</a>
        </li>
    
        <li>
            <a href="../posts/2023-01-22-openshift-feature-gates.html">Enabling Kubernetes feature gates in OpenShift</a>
        </li>
    
        <li>
            <a href="../posts/2022-08-29-jax-rs-header-formatting.html">Controlling header formatting in JAX-RS applications</a>
        </li>
    
        <li>
            <a href="../posts/2022-03-24-k8s-external-dns.html">Experimenting with ExternalDNS</a>
        </li>
    
        <li>
            <a href="../posts/2022-02-02-openshift-user-ns-without-anyuid.html">Running Pods in user namespaces without privileged SCCs</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
