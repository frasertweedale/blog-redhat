<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Fixing expired system certificates in FreeIPA</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a href="../tags/freeipa.html">freeipa</a>, <a href="../tags/troubleshooting.html">troubleshooting</a>, <a href="../tags/renewal.html">renewal</a>, <a href="../tags/certificates.html">certificates</a>
    
</div>

<div id="postContent">
    <h1 id="fixing-expired-system-certificates-in-freeipa">Fixing expired system certificates in FreeIPA</h1>
<p>In previous posts I outlined and demonstrated the <code>pki-server cert-fix</code> tool. This tool is part of Dogtag PKI. I also discussed what additional functionality would be needed to successfully use this tool in a FreeIPA environment.</p>
<p>This post details the result of the effort to make <code>cert-fix</code> useful for FreeIPA administrators. We implemented a wrapper program, <code>ipa-cert-fix</code>, which performs FreeIPA-specific steps in addition to executing <code>pki-server cert-fix</code>.</p>
<h2 id="what-does-ipa-cert-fix-do">What does <code>ipa-cert-fix</code> do?</h2>
<p>In brief, the steps performed by <code>ipa-cert-fix</code> are:</p>
<ol type="1">
<li>Inspect deployment to work out which certificates need renewing. This includes both Dogtag system certificates, FreeIPA-specific certificates (HTTP, LDAP, KDC and IPA RA).</li>
<li>Print intentions and await operator confirmation.</li>
<li>Invoke <code>pki-server cert-fix</code> to renew expired certificates, including FreeIPA-specific certificates.</li>
<li>Install renewed FreeIPA-specific certificates to their respective locations.</li>
<li>If any shared certificates were renewed (Dogtag system certificates excluding HTTP, and IPA RA), import them to the LDAP <code>ca_renewal</code> subtree and set the <code>caRenewalMaster</code> configuration to be the current server. This allows CA replicas to pick up the renewed shared certificates.</li>
<li>Restart FreeIPA (<code>ipactl restart</code>).</li>
</ol>
<h2 id="demonstration">Demonstration</h2>
<p>For this demonstration I used a deployment with the following characteristics:</p>
<ul>
<li>Two servers, <code>f29-0</code> and <code>f29-1</code>, with CA on both.</li>
<li><code>f29-0</code> is the current <em>CA renewal master</em>.</li>
<li>A KRA instance is installed on <code>f29-1</code>.</li>
<li>The deployment was created on 2019-05-24, so most of the certificates expire on or before 2021-05-24 (the exception being the CA certificate).</li>
</ul>
<p>On <strong>both servers</strong> I disabled <code>chronyd</code> and put the clock forward 27 months, so that all the certificates (except the IPA CA itself) are expired:</p>
<pre><code>[f29-1] ftweedal% sudo systemctl stop chronyd
[f29-1] ftweedal% date
Fri May 24 12:01:16 AEST 2019
[f29-1] ftweedal% sudo date 082412012021
Tue Aug 24 12:01:00 AEST 2021</code></pre>
<p>We want to perform this step on all machines in the topology. After all, we are simulating the passage of time.</p>
<p>After <code>ipactl restart</code> the Dogtag CA did not start, and we cannot communicate with FreeIPA due to the expired HTTP certificate:</p>
<pre><code>[f29-1] ftweedal% sudo ipactl status
Directory Service: RUNNING
krb5kdc Service: RUNNING
kadmin Service: RUNNING
httpd Service: RUNNING
ipa-custodia Service: RUNNING
pki-tomcatd Service: STOPPED
ipa-otpd Service: RUNNING
ipa: INFO: The ipactl command was successful

[f29-1] ftweedal% ipa user-find
ipa: ERROR: cannot connect to 'https://f29-1.ipa.local/ipa/json':
  [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed:
  certificate has expired (_ssl.c:1056)</code></pre>
<h3 id="fixing-the-first-server">Fixing the first server</h3>
<p>I will repair <code>f29-1</code> first, so that we can see why resetting the CA renewal master is an important step performed by <code>ipa-cert-fix</code>.</p>
<p>I ran <code>ipa-cert-fix</code> as <code>root</code>. It analyses the server, then prints a warning and the list of certificates to be renewed, and asks for confirmation:</p>
<pre><code>[f29-1] ftweedal% sudo ipa-cert-fix

                          WARNING

ipa-cert-fix is intended for recovery when expired certificates
prevent the normal operation of FreeIPA.  It should ONLY be used
in such scenarios, and backup of the system, especially certificates
and keys, is STRONGLY RECOMMENDED.


The following certificates will be renewed:

Dogtag sslserver certificate:                                                                                                                                                                                [2/34]
  Subject: CN=f29-1.ipa.local,O=IPA.LOCAL 201905222205                                                                                                                                                             
  Serial:  13
  Expires: 2021-05-12 05:55:47

Dogtag subsystem certificate:
  Subject: CN=CA Subsystem,O=IPA.LOCAL 201905222205
  Serial:  4
  Expires: 2021-05-11 12:07:11

Dogtag ca_ocsp_signing certificate:
  Subject: CN=OCSP Subsystem,O=IPA.LOCAL 201905222205
  Serial:  2
  Expires: 2021-05-11 12:07:11

Dogtag ca_audit_signing certificate:
  Subject: CN=CA Audit,O=IPA.LOCAL 201905222205
  Serial:  5
  Expires: 2021-05-11 12:07:12

Dogtag kra_transport certificate:
  Subject: CN=KRA Transport Certificate,O=IPA.LOCAL 201905222205
  Serial:  268369921
  Expires: 2021-05-12 06:00:10

Dogtag kra_storage certificate:
  Subject: CN=KRA Storage Certificate,O=IPA.LOCAL 201905222205
  Serial:  268369922
  Expires: 2021-05-12 06:00:10

Dogtag kra_audit_signing certificate:
  Subject: CN=KRA Audit,O=IPA.LOCAL 201905222205
  Serial:  268369923
  Expires: 2021-05-12 06:00:11

IPA IPA RA certificate:
  Subject: CN=IPA RA,O=IPA.LOCAL 201905222205
  Serial:  7
  Expires: 2021-05-11 12:07:47

IPA Apache HTTPS certificate:
  Subject: CN=f29-1.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  12
  Expires: 2021-05-23 05:54:11

IPA LDAP certificate:
  Subject: CN=f29-1.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  11
  Expires: 2021-05-23 05:53:58

IPA KDC certificate:
  Subject: CN=f29-1.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  14
  Expires: 2021-05-23 05:57:50

Enter &quot;yes&quot; to proceed:</code></pre>
<p>Observe that the KRA certificates are included (we are on <code>f29-1</code>). I type “yes” and continue. After a few minutes the process has completed:</p>
<pre><code>Proceeding.
Renewed Dogtag sslserver certificate:
  Subject: CN=f29-1.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  268369925
  Expires: 2023-08-14 02:19:33

... (9 certificates elided)

Renewed IPA KDC certificate:
  Subject: CN=f29-1.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  268369935
  Expires: 2023-08-25 02:19:42

Becoming renewal master.
The ipa-cert-fix command was successful</code></pre>
<p>As suggested by the expiry dates, it took about 11 seconds to renew all 11 certifiates. So why did it take so long? The <code>pki-server cert-fix</code> command, which is part of Dogtag and invoked by <code>ipa-cert-fix</code>, restarts the Dogtag instance as its final step. Although a new LDAP certificate was issued, it is not yet been installed in 389’s certificate database. Dogtag fails to start; it cannot talk to LDAP because of the expired certificate, and the restart operation hangs for a while. <code>ipa-cert-fix</code> knows to expect this and ignores the <code>pki-server cert-fix</code> failure when the LDAP certificate needs renewal.</p>
<p><code>ipa-cert-fix</code> also reported that it was setting the renewal master (because shared certificates were renewed). Let’s check the server status and verify the configuration.</p>
<pre><code>[f29-1] ftweedal% sudo ipactl status
Directory Service: RUNNING
krb5kdc Service: RUNNING
kadmin Service: RUNNING
httpd Service: RUNNING
ipa-custodia Service: RUNNING
pki-tomcatd Service: RUNNING
ipa-otpd Service: RUNNING
ipa: INFO: The ipactl command was successful</code></pre>
<p>The server is up and running.</p>
<pre><code>[f29-1] ftweedal% kinit admin
Password for admin@IPA.LOCAL:
Password expired.  You must change it now.
Enter new password:
Enter it again:</code></pre>
<p>Passwords have expired (due to time-travel).</p>
<pre><code>[f29-1] ftweedal% ipa config-show |grep renewal
  IPA CA renewal master: f29-1.ipa.local</code></pre>
<p><code>f29-1</code> has indeed become the renewal master. Oh, and the HTTP and LDAP certifiate have been fixed.</p>
<pre><code>[f29-1] ftweedal% ipa cert-show 1 | grep Subject
  Subject: CN=Certificate Authority,O=IPA.LOCAL 201905222205</code></pre>
<p>And the IPA framework can talk to Dogtag. This proves that the IPA RA and Dogtag HTTPS and subsystem certificates are valid.</p>
<h3 id="fixing-subsequent-servers">Fixing subsequent servers</h3>
<p>Jumping back onto <code>f29-0</code>, let’s look at the Certmonger request statuses:</p>
<pre><code>[f29-0] ftweedal% sudo getcert list \
                  | egrep '^Request|status:|subject:'
Request ID '20190522120745':
        status: CA_UNREACHABLE
        subject: CN=IPA RA,O=IPA.LOCAL 201905222205
Request ID '20190522120831':
        status: CA_UNREACHABLE
        subject: CN=CA Audit,O=IPA.LOCAL 201905222205
Request ID '20190522120832':
        status: CA_UNREACHABLE
        subject: CN=OCSP Subsystem,O=IPA.LOCAL 201905222205
Request ID '20190522120833':
        status: CA_UNREACHABLE
        subject: CN=CA Subsystem,O=IPA.LOCAL 201905222205
Request ID '20190522120834':
        status: MONITORING
        subject: CN=Certificate Authority,O=IPA.LOCAL 201905222205
Request ID '20190522120835':
        status: CA_UNREACHABLE
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
Request ID '20190522120903':
        status: CA_UNREACHABLE
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
Request ID '20190522120932':
        status: CA_UNREACHABLE
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
Request ID '20190522120940':
        status: CA_UNREACHABLE
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205</code></pre>
<p>The <code>MONITORING</code> request is the CA certificate. All the other requests are stuck in <code>CA_UNREACHABLE</code>.</p>
<p>The Certmonger tracking requests need to communicate with LDAP to retrieve shared certificates. So we have to <code>ipactl restart</code> with <code>--force</code> to ignore individual service startup failures (Dogtag will fail):</p>
<pre><code>[f29-0] ftweedal% sudo ipactl restart --force
Skipping version check
Starting Directory Service
Starting krb5kdc Service
Starting kadmin Service
Starting httpd Service
Starting ipa-custodia Service
Starting pki-tomcatd Service
Starting ipa-otpd Service
ipa: INFO: The ipactl command was successful

[f29-0] ftweedal% sudo ipactl status
Directory Service: RUNNING
krb5kdc Service: RUNNING
kadmin Service: RUNNING
httpd Service: RUNNING
ipa-custodia Service: RUNNING
pki-tomcatd Service: STOPPED
ipa-otpd Service: RUNNING
ipa: INFO: The ipactl command was successful</code></pre>
<p>Now Certmonger is able to renew the shared certificates by retrieving the new certificate from LDAP. The IPA-managed certificates are also able to be renewed by falling back to requesting them from another CA server (the already repaired <code>f29-1</code>). After a short wait, <code>getcert list</code> shows that all but one of the certificates have been renewed:</p>
<pre><code>[f29-0] ftweedal% sudo getcert list \
                  | egrep '^Request|status:|subject:'
Request ID '20190522120745':
        status: MONITORING
        subject: CN=IPA RA,O=IPA.LOCAL 201905222205
Request ID '20190522120831':
        status: MONITORING
        subject: CN=CA Audit,O=IPA.LOCAL 201905222205
Request ID '20190522120832':
        status: MONITORING
        subject: CN=OCSP Subsystem,O=IPA.LOCAL 201905222205
Request ID '20190522120833':
        status: MONITORING
        subject: CN=CA Subsystem,O=IPA.LOCAL 201905222205
Request ID '20190522120834':
        status: MONITORING
        subject: CN=Certificate Authority,O=IPA.LOCAL 201905222205
Request ID '20190522120835':
        status: CA_UNREACHABLE
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
Request ID '20190522120903':
        status: MONITORING
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
Request ID '20190522120932':
        status: MONITORING
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
Request ID '20190522120940':
        status: MONITORING
        subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205</code></pre>
<p>The final <code>CA_UNREACHABLE</code> request is the Dogtag HTTP certificate. We can now run <code>ipa-cert-fix</code> on <code>f29-0</code> to repair this certificate:</p>
<pre><code>[f29-0] ftweedal% sudo ipa-cert-fix

                          WARNING

ipa-cert-fix is intended for recovery when expired certificates
prevent the normal operation of FreeIPA.  It should ONLY be used
in such scenarios, and backup of the system, especially certificates
and keys, is STRONGLY RECOMMENDED.


The following certificates will be renewed:

Dogtag sslserver certificate:
  Subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  3
  Expires: 2021-05-11 12:07:11

Enter &quot;yes&quot; to proceed: yes
Proceeding.
Renewed Dogtag sslserver certificate:
  Subject: CN=f29-0.ipa.local,O=IPA.LOCAL 201905222205
  Serial:  15
  Expires: 2023-08-14 04:25:05

The ipa-cert-fix command was successful</code></pre>
<h3 id="all-done">All done?</h3>
<p>Yep. A subsequent execution of <code>ipa-cert-fix</code> shows that there is nothing to do, and exits:</p>
<pre><code>[f29-0] ftweedal% sudo ipa-cert-fix
Nothing to do.
The ipa-cert-fix command was successful</code></pre>
<h2 id="feature-status">Feature status</h2>
<p>Against the usual procedure for FreeIPA (and Red Hat projects in general), <code>ipa-cert-fix</code> was developed “downstream-first”. It has been merged to the <code>ipa-4-6</code> branch, but there might not even be another upstream release from that branch. But there might be a future RHEL release based on that branch (the savvy reader might infer a high degree of certainty, given we actually bothered to do that…)</p>
<p>In the meantime, work to forward-port the feature to <code>master</code> and newer branches is ongoing. I hope that it will be merged in the next week or so.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2019-12-06-freeipa-acme-plans.html">Plans for ACME support in FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2019-10-24-removing-ipa-ca.html">Removing the CA from a FreeIPA deployment</a>
        </li>
    
        <li>
            <a href="../posts/2019-09-23-direct-integration-ipa-certs.html">Requesting certificates from FreeIPA on Active Directory clients</a>
        </li>
    
        <li>
            <a href="../posts/2019-08-02-validity-exceeding-ca.html">Certificates need not be limited to the CA’s validity period</a>
        </li>
    
        <li>
            <a href="../posts/2019-07-26-dogtag-replica-ranges.html">Dogtag replica range management</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
