<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Docker build context and symbolic links</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a href="../tags/containers.html">containers</a>
    
</div>

<div id="postContent">
    <h1 id="docker-build-context-and-symbolic-links">Docker build context and symbolic links</h1>
<p><a href="https://www.docker.io/">Docker</a> is an application container system for Linux. Under the hood it’s like FreeBSD <em>jails</em>, but on top of that it provides powerful <em>image</em> specification and indexing capabilities. Images are built up in <em>layers</em>; each image depends on some other image (down to a <em>base image</em>), so a particular image might be a small delta on some shared dependency.</p>
<p>In investigating ways to <em>Dockerize</em> FreeIPA, particularly for ease of sharing development builds, it makes sense to base builds on an image that contains all the build dependencies. Since the dependencies are the same for any build, they can be made available in a single image to shave down the build time and reduce the size of the final images.</p>
<p>So there will be one <code>Dockerfile</code> for the builddeps image. But we will need another <code>Dockerfile</code> for the build itself, which will depend on the builddeps image. Each <code>Dockerfile</code> must reside in its own directory - there is no facility for specifying a different filename, e.g. <code>Dockerfile.builddep</code> - yet each <code>Dockerfile</code> needs to access some files in the root of the repository, e.g. <code>freeipa.spec.in</code>.</p>
<p>My initial approach is to have the builddep <code>Dockerfile</code> live in the repository at <code>docker/freeipa-builddep/Dockerfile</code>. The file consists of <em>instructions</em> specifying the image to build the new image <code>FROM</code>, files to <code>ADD</code> into the image, and commands to <code>RUN</code>. The initial <code>Dockerfile</code> is:</p>
<pre><code>FROM fedora:20
ADD ../../freeipa.spec.in freeipa.spec.in
RUN cp freeipa.spec.in freeipa-builddep.spec
RUN yum-builddep freeipa-builddep.spec</code></pre>
<p>Let’s attempt to build the image:</p>
<pre><code>% sudo docker build .
Uploading context 3.072 kB
Uploading context
Step 0 : FROM fedora:20
 ---&gt; b7de3133ff98
Step 1 : ADD ../../freeipa.spec.in freeipa.spec.in
2014/05/19 16:34:21 ../../freeipa.spec.in: no such file or directory</code></pre>
<p>The <em>context</em> of a build is the contents of the directory containing the <code>Dockerfile</code>. Attempting to reference files outside the context fails. The <code>ADD</code> instruction <a href="http://docs.docker.io/reference/builder/#add">documentation</a> does kindly mention this.</p>
<p>We certainly don’t want multiple copies of <code>freeipa.spec.in</code> floating around, so perhaps we can use a symbolic link. The <code>Dockerfile</code> now reads:</p>
<pre><code>FROM fedora:20
ADD freeipa.spec.in freeipa.spec.in
RUN cp freeipa.spec.in freeipa-builddep.spec
RUN yum-builddep freeipa-builddep.spec</code></pre>
<p>Creating the symlink and trying the build again:</p>
<pre><code>% cd docker/freeipa-builddep/
% ln -s ../../freeipa.spec.in
% docker build .
Uploading context 3.072 kB
Uploading context
Step 0 : FROM fedora:20
 ---&gt; b7de3133ff98
Step 1 : ADD freeipa.spec.in freeipa.spec.in
2014/05/19 16:45:06 freeipa.spec.in: no such file or directory</code></pre>
<p>Docker really does not like symlinks.</p>
<p>I’m not sure how to proceed from here, and will be seeking feedback from the other FreeIPA developers since the other options are either intrusive (different <code>Dockerfile</code> = different branch) or hacky (e.g. pulling things in from URLs, or multiple copies of spec file in repository). Perhaps I am overlooking a nice solution, or perhaps one will come about soon given that Docker is still under heavy development.</p>
<p>Stay tuned.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2019-07-19-revocation-self-service.html">Designing revocation self-service for FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2019-05-28-a-dn-is-not-a-string.html">A Distinguished Name is not a string</a>
        </li>
    
        <li>
            <a href="../posts/2019-05-24-ipa-cert-fix.html">Fixing expired system certificates in FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2019-03-18-cert-fix-redux.html"><code>cert-fix</code> redux</a>
        </li>
    
        <li>
            <a href="../posts/2019-03-04-dogtag-system-cert-lifetime.html">Customising Dogtag system certificate lifetimes</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
