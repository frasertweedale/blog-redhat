<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Running Keycloak in OpenShift</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'containers'." href="../tags/containers.html">containers</a>, <a title="All pages tagged 'idm'." href="../tags/idm.html">idm</a>, <a title="All pages tagged 'openshift'." href="../tags/openshift.html">openshift</a>
    
</div>

<div id="postContent">
    <h1 id="running-keycloak-in-openshift">Running Keycloak in OpenShift</h1>
<p>At PyCon Australia in August I gave a presentation about federated and social identity. I demonstrated concepts using <a href="http://www.keycloak.org/">Keycloak</a>, an Open Source, feature rich <em>identity broker</em>. Keycloak is deployed in JBoss, so I wasn’t excited about the prospect of setting up Keycloak from scratch. Fortunately there is an <a href="https://hub.docker.com/r/jboss/keycloak/">official Docker image</a> for Keycloak, so with that as the starting point I took an opportunity to finally learn about OpenShift v3, too.</p>
<p>This post is simply a recounting of how I ran Keycloak on OpenShift. Along the way we will look at how to get the containerised Keycloak to trust a private certificate authority (CA).</p>
<p>One thing that is not discussed is how to get Keycloak to persist configuration and user records to a database. This was not required for my demo, but it will be important in a production deployment. Nevertheless I hope this article is a useful starting point for someone wishing to deploy Keycloak on OpenShift.</p>
<h2 id="bringing-up-a-local-openshift-cluster">Bringing up a local OpenShift cluster</h2>
<p>To deploy Keycloak on OpenShift, one must first have an OpenShift. <a href="https://www.openshift.com/">OpenShift Online</a> is Red Hat’s public PaaS offering. Although running the demo on a public PaaS was my first choice, OpenShift Online was experiencing issues at the time I was setting up my demo. So I sought a local solution. This approach would have the additional benefit of not being subject to the whims of conference networks (or, it was supposed to - but that is a story for another day!)</p>
<h3 id="oc-cluster-up"><code>oc cluster up</code></h3>
<p>Next I tried <code>oc cluster up</code>. <code>oc</code> is the official OpenShift client program. On Fedora, it is provided by the <code>origin-clients</code> package. <code>oc cluster up</code> command pulls required images and brings up an OpenShift cluster running on the system’s Docker infrastructure. The command takes no further arguments; it really is that simple! Or is it…?</p>
<pre><code>% oc cluster up
-- Checking OpenShift client ... OK
-- Checking Docker client ... OK
-- Checking Docker version ... OK
-- Checking for existing OpenShift container ... OK
-- Checking for openshift/origin:v1.5.0 image ...
   Pulling image openshift/origin:v1.5.0
   Pulled 0/3 layers, 3% complete
   ...
   Pulled 3/3 layers, 100% complete
   Extracting
   Image pull complete
-- Checking Docker daemon configuration ... FAIL
   Error: did not detect an --insecure-registry argument on the Docker daemon
   Solution:

     Ensure that the Docker daemon is running with the following argument:
        --insecure-registry 172.30.0.0/16</code></pre>
<p>OK, so it is not that simple. But it got a fair way along, and (kudos to the OpenShift developers) they have provided actionable feedback about how to resolve the issue. I added <code>--insecure-registry 172.30.0.0/16</code> to the <code>OPTIONS</code> variable in <code>/etc/sysconfig/docker</code>, then restarted Docker and tried again:</p>
<pre><code>% oc cluster up
-- Checking OpenShift client ... OK
-- Checking Docker client ... OK
-- Checking Docker version ... OK
-- Checking for existing OpenShift container ... OK
-- Checking for openshift/origin:v1.5.0 image ... OK
-- Checking Docker daemon configuration ... OK
-- Checking for available ports ... OK
-- Checking type of volume mount ...
   Using nsenter mounter for OpenShift volumes
-- Creating host directories ... OK
-- Finding server IP ...
   Using 192.168.0.160 as the server IP
-- Starting OpenShift container ...
   Creating initial OpenShift configuration
   Starting OpenShift using container 'origin'
   Waiting for API server to start listening
-- Adding default OAuthClient redirect URIs ... OK
-- Installing registry ... OK
-- Installing router ... OK
-- Importing image streams ... OK
-- Importing templates ... OK
-- Login to server ... OK
-- Creating initial project &quot;myproject&quot; ... OK
-- Removing temporary directory ... OK
-- Checking container networking ... OK
-- Server Information ... 
   OpenShift server started.
   The server is accessible via web console at:
       https://192.168.0.160:8443

   You are logged in as:
       User:     developer
       Password: developer

   To login as administrator:
       oc login -u system:admin</code></pre>
<p>Success! Unfortunately, on my machine with several virtual network, <code>oc cluster up</code> messed a bit too much with the routing tables, and when I deployed Keycloak on this cluster it was unable to communicate with my VMs. No doubt these issues could have been solved, but being short on time and with other approaches to try, I abandoned this approach.</p>
<h3 id="minishift"><em>Minishift</em></h3>
<p><a href="https://www.openshift.org/minishift/">Minishift</a> is a tool that launches a single-node OpenShift cluster in a VM. It supports a variety of operating systems and hypervisors. On GNU+Linux it supports KVM and VirtualBox.</p>
<p>First install <a href="https://github.com/docker/machine/releases">docker-machine</a> and <a href="https://github.com/dhiltgen/docker-machine-kvm/releases">docker-machine-driver-kvm</a>. (follow the instructions at the preceding links). Unfortunately these are not yet packaged for Fedora.</p>
<p>Download and extract the Minishift release for your OS from <a href="https://github.com/minishift/minishift/releases">https://github.com/minishift/minishift/releases</a>.</p>
<p>Run <code>minishift start</code>:</p>
<pre><code>% ./minishift start
-- Installing default add-ons ... OK
Starting local OpenShift cluster using 'kvm' hypervisor...
Downloading ISO 'https://github.com/minishift/minishift-b2d-iso/releases/download/v1.0.2/minishift-b2d.iso'

... wait a while ...</code></pre>
<p>It downloads a <a href="http://boot2docker.io/">boot2docker</a> VM image containing the openshift cluster, boots the VM, and the console output then resembles the output of <code>oc cluster up</code>. I deduce that <code>oc cluster up</code> is being executed on the VM.</p>
<p>At this point, we’re ready to go. Before I continue, it is important to note that once you have access to an OpenShift cluster, the user experience of creating and managing applications is essentially the same. The commands in the following sections are relevant, regardless whether you are running your app on OpenShift online, on a cluster running on your workstation, or anything in between.</p>
<h2 id="preparing-the-keycloak-image">Preparing the Keycloak image</h2>
<p>The JBoss project provides official Docker images, including an <a href="https://hub.docker.com/r/jboss/keycloak/">official Docker image</a> for Keycloak. This image runs fine in plain Docker but the directory permissions are not correct for running in OpenShift.</p>
<p>The <code>Dockerfile</code> for this image is found in the <a href="https://github.com/jboss-dockerfiles/keycloak">jboss-dockerfiles/keycloak repository</a> on GitHub. Although they do not publish an official image for it, this repository also contains a <code>Dockerfile</code> for Keycloak on OpenShift! I was able to build that image myself and upload it to <a href="https://hub.docker.com/r/frasertweedale/keycloak-openshift/">my Docker Hub account</a>. The steps were as follows.</p>
<p>First clone the <code>jboss-dockerfiles</code> repo:</p>
<pre><code>% git clone https://github.com/jboss-dockerfiles/keycloak docker-keycloak
Cloning into 'docker-keycloak'...
remote: Counting objects: 1132, done.
remote: Compressing objects: 100% (22/22), done.
remote: Total 1132 (delta 14), reused 17 (delta 8), pack-reused 1102
Receiving objects: 100% (1132/1132), 823.50 KiB | 158.00 KiB/s, done.
Resolving deltas: 100% (551/551), done.
Checking connectivity... done.</code></pre>
<p>Next build the Docker image for OpenShift:</p>
<pre><code>% docker build docker-keycloak/server-openshift
Sending build context to Docker daemon 2.048 kB
Step 1 : FROM jboss/keycloak:latest
 ---&gt; fb3fc6a18e16
Step 2 : USER root
 ---&gt; Running in 21b672e19722
 ---&gt; eea91ef53702
Removing intermediate container 21b672e19722
Step 3 : RUN chown -R jboss:0 $JBOSS_HOME/standalone &amp;&amp;     chmod -R g+rw $JBOSS_HOME/standalone
 ---&gt; Running in 93b7d11f89af
 ---&gt; 910dc6c4a961
Removing intermediate container 93b7d11f89af
Step 4 : USER jboss
 ---&gt; Running in 8b8ccba42f2a
 ---&gt; c21eed109d12
Removing intermediate container 8b8ccba42f2a
Successfully built c21eed109d12</code></pre>
<p>Finally, tag the image into the repo and push it:</p>
<pre><code>% docker tag c21eed109d12 registry.hub.docker.com/frasertweedale/keycloak-openshift

% docker login -u frasertweedale registry.hub.docker.com
Password:
Login Succeeded

% docker push registry.hub.docker.com/frasertweedale/keycloak-openshift
... wait for upload ...
latest: digest: sha256:c82c3cc8e3edc05cfd1dae044c5687dc7ebd9a51aefb86a4bb1a3ebee16f341c size: 2623</code></pre>
<h3 id="adding-ca-trust">Adding CA trust</h3>
<p>For my demo, I used a local FreeIPA installation to issue TLS certificates for the the Keycloak app. I was also going to carry out a scenario where I configure Keycloak to use that FreeIPA installation’s LDAP server to authenticate users. I wanted to use TLS everywhere (eat your own dog food!) I needed the Keycloak application to trust the CA of one of my local FreeIPA installations. This made it necessary to build another Docker image based on the <code>keycloak-openshift</code> image, with the appropriate CA trust built in.</p>
<p>The content of the <code>Dockerfile</code> is:</p>
<pre><code>FROM frasertweedale/keycloak-openshift:latest
USER root
COPY ca.pem /etc/pki/ca-trust/source/anchors/ca.pem
RUN update-ca-trust
USER jboss</code></pre>
<p>The file <code>ca.pem</code> contains the CA certificate to add. It must be in the same directory as the <code>Dockerfile</code>. The build copies the CA certificate to the appropriate location and executes <code>update-ca-trust</code> to ensure that applications - including Java programs - will trust the CA.</p>
<p>Following the <code>docker build</code> I tagged the new image into my <code>hub.docker.com</code> repository (tag: <code>f25-ca</code>) and pushed it. And with that, we are ready to deploy Keycloak on OpenShift.</p>
<h2 id="creating-the-keycloak-application-in-openshift">Creating the Keycloak application in OpenShift</h2>
<p>At this point we have a local OpenShift cluster (via <em>Minishift</em>) and a Keycloak image (<code>frasertweedale/keycloak-openshift:f25-ca</code>) to deploy. When deploying the app we need to set some environment variables:</p>
<dl>
<dt><code>KEYCLOAK_USER=admin</code></dt>
<dd><p>A username for the Keycloak admin account to be created</p>
</dd>
<dt><code>KEYCLOAK_PASSWORD=secret123</code></dt>
<dd><p>Passphrase for the admin user</p>
</dd>
<dt><code>PROXY_ADDRESS_FORWARDING=true</code></dt>
<dd><p>Because the application will be running behind OpenShift’s HTTP proxy, we need to tell Keycloak to use the “external” hostname when creating hyperlinks, rather than Keycloak’s own view.</p>
</dd>
</dl>
<p>Use the <code>oc new-app</code> command to create and deploy the application:</p>
<pre><code>% oc new-app --docker-image frasertweedale/keycloak-openshift:f25-ca \
    --env KEYCLOAK_USER=admin \
    --env KEYCLOAK_PASSWORD=secret123 \
    --env PROXY_ADDRESS_FORWARDING=true
--&gt; Found Docker image 45e296f (4 weeks old) from Docker Hub for &quot;frasertweedale/keycloak-openshift:f25-ca&quot;

    * An image stream will be created as &quot;keycloak-openshift:f25-ca&quot; that will track this image
    * This image will be deployed in deployment config &quot;keycloak-openshift&quot;
    * Port 8080/tcp will be load balanced by service &quot;keycloak-openshift&quot;
      * Other containers can access this service through the hostname &quot;keycloak-openshift&quot;

--&gt; Creating resources ...
    imagestream &quot;keycloak-openshift&quot; created
    deploymentconfig &quot;keycloak-openshift&quot; created
    service &quot;keycloak-openshift&quot; created
--&gt; Success
    Run 'oc status' to view your app.</code></pre>
<p>The app gets created immediately but it is not ready yet. The download of the image and deployment of the container (or <em>pod</em> in OpenShift / Kubernetes terminology) will proceed in the background.</p>
<p>After a little while (depending on how long it takes to download the ~300MB Docker image) <code>oc status</code> will show that the deployment is up and running:</p>
<pre><code>% oc status
In project My Project (myproject) on server https://192.168.42.214:8443

svc/keycloak-openshift - 172.30.198.217:8080
  dc/keycloak-openshift deploys istag/keycloak-openshift:f25-ca 
    deployment #2 deployed 3 minutes ago - 1 pod

View details with 'oc describe &lt;resource&gt;/&lt;name&gt;' or list everything with 'oc get all'.</code></pre>
<p>(In my case, the first deployment failed because the 10-minute timeout elapsed before the image download completed; hence <code>deployment #2</code> in the output above.)</p>
<h3 id="creating-a-secure-route">Creating a secure route</h3>
<p>Now the Keycloak application is running, but we cannot reach it from outside the Keycloak project itself. In order to be able to reach it there must be a <em>route</em>. The <code>oc create route</code> command lets us create a route that uses TLS (so clients can authenticate the service). We will use the domain name <code>keycloak.ipa.local</code>. The public/private keypair and certificate have already been generated (how to do that is outside the scope of this article). The certificate was signed by the CA we added to the image earlier. The service name - visible in the <code>oc status</code> output above - is <code>svc/keycloak-openshift</code>.</p>
<pre><code>% oc create route edge \
  --service svc/keycloak-openshift \
  --hostname keycloak.ipa.local \
  --key /home/ftweedal/scratch/keycloak.ipa.local.key \
  --cert /home/ftweedal/scratch/keycloak.ipa.local.pem
route &quot;keycloak-openshift&quot; created</code></pre>
<p>Assuming there is a DNS entry pointing <code>keycloak.ipa.local</code> to the OpenShift cluster, and that the system trusts the CA that issued the certificate, we can now visit our Keycloak application:</p>
<pre><code>% curl https://keycloak.ipa.local/
&lt;!--
  ~ Copyright 2016 Red Hat, Inc. and/or its affiliates
  ~ and other contributors as indicated by the @author tags.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  --&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=/auth/&quot; /&gt;
    &lt;meta name=&quot;robots&quot; content=&quot;noindex, nofollow&quot;&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        window.location.href = &quot;/auth/&quot;
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
    If you are not redirected automatically, follow this &lt;a href='/auth'&gt;link&lt;/a&gt;.
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>If you visit in a browser, you will be able to log in using the admin account credentials specified in the <code>KEYCLOAK_USER</code> and <code>KEYCLOAK_PASSWORD</code> environment variables specified when the app was created. And from there you can create and manage authentication realms, but that is beyond the scope of this article.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post I discussed how to run Keycloak in OpenShift, from bringing up an OpenShift cluster to building the Docker image and creating the application and route in OpenShift. I recounted that I found <em>OpenShift Online</em> unstable at the time I tried it, and that although <code>oc cluster up</code> did successfully bring up a cluster I had trouble getting the Docker and VM networks to talk to each other. Eventually I tried <em>Minishift</em> which worked well.</p>
<p>We saw that although there is no official Docker image for Keycloak in OpenShift, there is a <code>Dockerfile</code> that builds a working image. It is easy to further extend the image to add trust for private CAs.</p>
<p>Creating the Keycloak app in OpenShift, and adding the routes, is straightforward. There are a few important environment variables that must be set. The <code>oc create route</code> command was used to create a secure route to access the application from the outside.</p>
<p>We did not discuss how to set up Keycloak with a database for persisting configuration and user records. The deployment we created is ephemeral. This satisfied my needs for demonstration purposes but production deployments will require persistence. There are official JBoss Docker images that extend the base Keycloak image and add <a href="https://hub.docker.com/r/jboss/keycloak-postgres/">support for PostgreSQL</a>, <a href="https://hub.docker.com/r/jboss/keycloak-mysql/">MySQL</a> and <a href="https://hub.docker.com/r/jboss/keycloak-mongo/">MongoDB</a>. I have not tried these but I’d suggest starting with one of these images if you are looking to do a production deployment. Keep in mind that these images may not include the changes that are required for deploying in OpenShift.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2020-06-19-dogtag-lightweight-ca-crl.html">CRLs for Dogtag Lightweight CAs</a>
        </li>
    
        <li>
            <a href="../posts/2020-05-13-ipa-acme-dns.html">ACME DNS challenges and FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2020-05-07-ipa-acme-mod_md.html">ACME for Apache httpd with mod_md</a>
        </li>
    
        <li>
            <a href="../posts/2020-05-06-ipa-acme-intro.html">Introducing the FreeIPA ACME service</a>
        </li>
    
        <li>
            <a href="../posts/2020-01-28-freeipa-override-ca-key-size.html">Deploying FreeIPA with a 4096-bit CA signing key</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
