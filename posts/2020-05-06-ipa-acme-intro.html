<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Introducing the FreeIPA ACME service</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'acme'." href="../tags/acme.html">acme</a>, <a title="All pages tagged 'certificates'." href="../tags/certificates.html">certificates</a>, <a title="All pages tagged 'freeipa'." href="../tags/freeipa.html">freeipa</a>
    
</div>

<div id="postContent">
    <h1 id="introducing-the-freeipa-acme-service">Introducing the FreeIPA ACME service</h1>
<p><em>This post is part of a series of ACME client demonstrations. See also the posts about</em> <a href="2020-05-07-ipa-acme-mod_md.html">mod_md for Apache</a> <em>and</em> <a href="2020-05-13-ipa-acme-dns.html">Certbot with FreeIPA DNS</a>.</p>
<p><em>Automated Certificate Management Environment (ACME)</em> is a protocol for automated identifier validation and certificate issuance. Its goal is to improve security on the Internet by reducing certificate lifetimes and avoiding manual processes from certificate lifecycle management.</p>
<p>ACME’s original use case is HTTPS on the public Internet. The public CA <a href="https://letsencrypt.org/">*Let's Encrypt*</a> is already one of the biggest CAs. Clients use ACME to talk to <em>Let’s Encrypt</em>, automating DNS name validation, certificate issuance and in most cases, certificate installation and renewal.</p>
<p>But ACME is not limited to Let’s Encrypt. Other CAs implement it and enterprise (private) CAs can implement it too. And after a few years of talking about it, we are finally implementing an ACME service in FreeIPA.</p>
<p>In this post I will give a high-level overview of the ACME protocol, and the ACME service architecture in FreeIPA. If that doesn’t interest you, scroll down to the demo where I show the Certbot ACME client acquiring a certificate from the FreeIPA CA.</p>
<h2 id="acme-protocol-in-brief">ACME protocol, in brief</h2>
<ol type="1">
<li><p>ACME client registers with ACME server. ACME accounts <em>may</em> be bound to some external accounts but more commonly clients register <em>ad hoc</em> with no binding to any other service. This is the case for the FreeIPA ACME service.</p></li>
<li><p>ACME client creates an <em>order</em> for a certificate with one or more <em>identifiers</em> (e.g. DNS names). The FreeIPA ACME service initially supports only DNS identifiers, but the IETF ACME working has defined challenges for other identifier types including IP addresses and email addresses.</p></li>
<li><p>ACME service offers <em>challenges</em> that the client can use to prove <em>control</em> of the identifier. For DNS names there are three challenge types:</p>
<dl>
<dt><code>dns-01</code></dt>
<dd><p>Client creates DNS records to prove control of the identifier.</p>
</dd>
<dt><code>http-01</code></dt>
<dd><p>Client provisions HTTP resource to prove control of the identifier.</p>
</dd>
<dt><code>tls-alpn-01</code></dt>
<dd><p>Client configures TLS server use <em>Application Layer Protocol Negotiation (ALPN)</em> and a special X.509 certificate to prove control of the identifier.</p>
</dd>
</dl>
<p>The FreeIPA ACME service currently implements the <code>dns-01</code> and <code>http-01</code> challenges.</p></li>
<li><p>Client responds to the challenge and advises ACME server to proceed with validation.</p></li>
<li><p>Server attempts to validate the clients response to the challenge. The identifier is <em>authorised</em> when sufficient challenges (usually one per identifier) have been validated.</p></li>
<li><p>After all identifiers in the order have been authorised, the client <em>finalises</em> the order causing the CA to issue the certificate.</p></li>
<li><p>The client retrieves the issued certificate and (commonly) configures an application to use it.</p></li>
</ol>
<p>There are many ACME client implementations. Some, such as <a href="https://certbot.eff.org/">Certbot</a>, are general purpose and can be used standalone or integrated with many kinds of applications. Others are application specific, like <a href="https://httpd.apache.org/docs/current/mod/mod_md.html">mod_md</a> for Apache httpd.</p>
<h2 id="freeipa-acme-service-architecture">FreeIPA ACME service architecture</h2>
<p>The FreeIPA ACME service uses <a href="https://www.dogtagpki.org/wiki/PKI_ACME_Responder">Dogtag PKI ACME responder</a>. This is an optional component of Dogtag, separate from the CA or other subsystems. Like other Dogtag subsystems it run in the same process and is accessed via Tomcat.</p>
<p>The Dogtag ACME subsystem will automatically be deployed on every CA server in a FreeIPA deployment. But <strong>it will not service requests</strong> until the administrator enables it. There are two reasons for this approach.</p>
<p>For ease of client configuration it is desired to have a single, permanent name for the ACME service across the whole topology. The topology should be able to evolve without having the reconfigure ACME clients. There is already a candidate DNS name that is either managed by FreeIPA (when using internal DNS) or required to managed by administrators (when not using internal DNS). That is <code>ipa-ca.$DOMAIN</code>. This points to all CA replicas in the topology. If we let administrators choose the FreeIPA servers upon which to configure the ACME service, we would have to introduce a new DNS name to manage. It will complicate code, and impose a new burden on administrators if the internal DNS is not used. By automatically deploying the ACME service on all CA replicas, the <code>ipa-ca.$DOMAIN</code> name is always a valid name for ACME clients to use.</p>
<p>The second reason is that there is just less for adminstrators to worry about. How do I install the ACME service? Don’t worry about it, it’s already there, just turn it on.</p>
<p>Turning the ACME service on or off, or other configuration changes, will be effected deployment-wide. At least, that is the goal. Early releases <em>might</em> require per-server configuration steps. But eventually configuration will be contained in the replicated LDAP database and administrators will just use regular <code>ipa</code> subcommands to control the ACME service deployment-wide.</p>
<p>The ACME database, too, will be replicated deployment wide. It is possible that some data, such as <em>nonces</em>, might have to be kept server-local for performance reasons (this is not the case now, but load testing is coming).</p>
<h2 id="demo-certbot-client-running-standalone-http-server">Demo: Certbot client running standalone HTTP server</h2>
<p>The following demo scenario was carried out on a FreeIPA-enrolled host. The ACME protocol requires the use of TLS between client and server. The FreeIPA ACME service certificate is (usually) signed by the FreeIPA CA, so the client needs to trust it. On machines that are not FreeIPA clients CA trust would have to be established by other means so that the ACME client will trust the ACME server.</p>
<p>The general purpose ACME client <a href="https://certbot.eff.org/">Certbot</a> integrates with many different server program and can also be used “standalone”. That is what I will do in this demo. It is not representative of real-world use but is a straightforward way to demonstrate that an ACME server is operating correctly.</p>
<p>The two steps, registration and issuance, can be rolled into a single command. For clarity I will keep these as two separate steps.</p>
<h3 id="registration">Registration</h3>
<p>First, the registration step creates an account with the ACME service:</p>
<pre><code>[root@f31-0 ~]# certbot \
    --server https://ipa-ca.ipa.local/acme/directory \
    register -m ftweedal@redhat.com --agree-tos \
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
Would you be willing to share your email address with the Electronic Frontier
Foundation, a founding partner of the Let's Encrypt project and the non-profit
organization that develops Certbot? We'd like to send you email about our work
encrypting the web, EFF news, campaigns, and ways to support digital freedom.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
(Y)es/(N)o: n

IMPORTANT NOTES:
 - Your account credentials have been saved in your Certbot
   configuration directory at /etc/letsencrypt. You should make a
   secure backup of this folder now. This configuration directory will
   also contain certificates and private keys obtained by Certbot so
   making regular backups of this folder is ideal.</code></pre>
<p>By default Certbot will contact <em>Let’s Encrypt</em>, the public CA. The <code>--server</code> option is given to point Certbot to the FreeIPA ACME service instead.</p>
<p><code>-m</code> gives a contact email address (this is optional). <code>--agree-tos</code> agrees to the terms of service of the ACME server. The “share email with EFF” prompt is only relevant when using Let’s Encrypt and can be ignored.</p>
<h3 id="identifier-validation-and-certificate-issuance">Identifier validation and certificate issuance</h3>
<p>and ACME account then request a certificate for the machine’s hostname from the FreeIPA CA.</p>
<p>The next step is to issue the certificate. The <code>certonly</code> command means: just write the issued certificate to disk; don’t configure any programs to use it. The <code>--domain</code> option can be given multiple times to request a certificate with multiple subject alternative names.</p>
<p>The <code>--standalone</code> option tells Certbot to start its own HTTP server to fulfil the <code>http-01</code> challenge. This server will listen on <code>tcp/80</code> therefore it must run as <code>root</code>. In typical production scenarios Certbot will instead integrate with existing HTTP servers and avoid running it with <code>root</code> privileges. Or you would use an alternative client implementation suited to your use case.</p>
<pre><code>[root@f31-0 ~]# certbot \
    --server https://ipa-ca.ipa.local/acme/directory \
    certonly \
    --domain $(hostname) \
    --standalone
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator standalone, Installer None
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for f31-0.ipa.local
Waiting for verification...
Cleaning up challenges

IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/f31-0.ipa.local/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/f31-0.ipa.local/privkey.pem
   Your cert will expire on 2020-08-03. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   &quot;certbot renew&quot;
 - If you like Certbot, please consider supporting our work by:

   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
   Donating to EFF:                    https://eff.org/donate-le</code></pre>
<p>The whole command completed in a few seconds. Below is the pretty print of the certificate. Observe the ~3 month validity and that the issuer is the FreeIPA CA, not Let’s Encrypt.</p>
<pre><code>[root@f31-0 ~]# openssl x509 -text -noout -in /etc/letsencrypt/live/f31-0.ipa.local/cert.pem
Certificate:
  Data:
  Version: 3 (0x2)
  Serial Number: 25 (0x19)
  Signature Algorithm: sha256WithRSAEncryption
  Issuer: O = IPA.LOCAL 202004011654, CN = Certificate Authority
  Validity
      Not Before: May  5 11:30:33 2020 GMT
      Not After : Aug  3 11:30:33 2020 GMT
  Subject: CN = f31-0.ipa.local
  Subject Public Key Info:
      Public Key Algorithm: rsaEncryption
          RSA Public-Key: (2048 bit)
          Modulus:
              &lt;snip&gt;
          Exponent: 65537 (0x10001)
  X509v3 extensions:
      X509v3 Subject Key Identifier: 
          2D:75:79:C2:A0:8C:EF:44:D2:6B:E4:19:E6:BC:42:23:BA:66:1E:D9
      X509v3 Authority Key Identifier: 
          keyid:5E:55:7C:10:82:C1:19:09:E2:42:EC:65:96:89:08:50:35:62:FE:8F

      X509v3 Subject Alternative Name: 
          DNS:f31-0.ipa.local
      X509v3 Key Usage: critical
          Digital Signature, Key Encipherment
      X509v3 Extended Key Usage: 
          TLS Web Server Authentication, TLS Web Client Authentication
      Authority Information Access: 
          OCSP - URI:http://ipa-ca.ipa.local/ca/ocsp

      X509v3 CRL Distribution Points: 

          Full Name:
            URI:http://ipa-ca.ipa.local/ipa/crl/MasterCRL.bin
          CRL Issuer:
            DirName:O = ipaca, CN = Certificate Authority

  Signature Algorithm: sha256WithRSAEncryption
       &lt;snip&gt;</code></pre>
<h2 id="discussion">Discussion</h2>
<p>In this post I demonstrated just one basic client scenario. In upcoming posts I will explore some more advanced and more realistic client scenarios including use of the DNS-based challenges and the <a href="https://httpd.apache.org/docs/current/mod/mod_md.html">mod_md</a> client module for Apache httpd.</p>
<p>The Dogtag ACME responder and FreeIPA ACME service are still undergoing rapid development and are <strong>not production ready</strong>. Some parts of the Dogtag implementation have made their way into releases, but should be considered a “preview”. That said, if you would like to play with the ACME service or perform integration testing, we are happy to collaborate and you should reach out on <code>pki-devel@redhat.com</code>.</p>
<p>The fact that ACME accounts have no “binding” to any existing FreeIPA may surprise some people. In the initial release we want to implement the “baseline” use case also addressed by the public ACME CAs (Let’s Encrypt). That is: <em>an essentially anonymous client proves control of an identifier and gets a certificate.</em> We recognise that organisiations <em>may</em> want ACME accounts to be associated with (or views of) existing identities, and implement authorisation policies based on those accounts and their groups. But we don’t <em>know</em> whether this is required, or exactly what it would look like. So we are going to “wait and see” if customers tell us what “enterprise ACME” should be. In the mean time we are focused on the core use case.</p>
<p>Other considerations for the FreeIPA ACME service include:</p>
<ul>
<li>customising the ACME certificate profile (e.g. altering the validity period, Certificate Policies extension, etc)</li>
<li>issuing ACME certificates from a sub-CA of the FreeIPA CA</li>
<li>controlling which validation challenges are enabled</li>
<li>block/allow lists or other mechanisms to decide whether a particular identifier (DNS name) can be issued via ACME</li>
</ul>
<p>All of these are on the roadmap, but they are likely to be deferred beyond the initial release.</p>
<h2 id="conclusion">Conclusion</h2>
<p>That’s all for this post. I’ll be following up soon with a post about using Apache <a href="https://httpd.apache.org/docs/current/mod/mod_md.html">mod_md</a> with the FreeIPA ACME service.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2020-11-30-openshift-machine-config-operator.html">Using the OpenShift Machine Config Operator</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-13-acme-service-discovery.html">ACME Service Discovery</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-05-openshift-user-namespace.html">OpenShift and user namespaces</a>
        </li>
    
        <li>
            <a href="../posts/2020-10-20-ipa-cert-long-hostname.html">Issuing certificates for long hostnames</a>
        </li>
    
        <li>
            <a href="../posts/2020-09-17-dogtag-vlv-corruption.html">Dogtag, number ranges and VLV indices</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
