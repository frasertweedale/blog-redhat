<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Customising Dogtag system certificate lifetimes</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a href="../tags/dogtag.html">dogtag</a>, <a href="../tags/profiles.html">profiles</a>, <a href="../tags/howto.html">howto</a>
    
</div>

<div id="postContent">
    <h1 id="customising-dogtag-system-certificate-lifetimes">Customising Dogtag system certificate lifetimes</h1>
<p>Default certificate lifetimes in Dogtag are 20 years for the CA certificate (when self-signed) and about 2 years for other system certificates. These defaults also apply to FreeIPA. It can be desirable to have shorter certificate lifetimes. And although I wouldn’t recommend to use <em>longer</em> lifetimes, people sometimes want that.</p>
<p>There is no <em>supported</em> mechanism for customising system certificate validity duration during Dogtag or FreeIPA installation. But it can be done. In this post I’ll explain how.</p>
<h2 id="profile-configuration-files">Profile configuration files</h2>
<p>During installation, profile configurations are copied from the RPM install locations under <code>/usr/share</code> to the new Dogtag instance’s configuration directory. If the LDAP profile subsystem is used (FreeIPA uses it) they are further copied from the instance configuration directory into the LDAP database.</p>
<p>There is no facility or opportunity to modify the profiles during installation. So if you want to customise the certificate lifetimes, you have to modify the files under <code>/usr/share</code>.</p>
<p>There are two directories that contain profile configurations:</p>
<dl>
<dt><code>/usr/share/pki/ca/profiles/ca/*.cfg</code></dt>
<dd><p>These profile configurations are available during general operation.</p>
</dd>
<dt><code>/usr/share/pki/ca/conf/*.profile</code></dt>
<dd><p>These <em>overlay</em> configurations used during installation when issuing system certificates. Each configuration references an underlying profile and can override or extend the configuration.</p>
</dd>
<dt><code>/usr/share/ipa/profiles/*.cfg</code></dt>
<dd><p>Profiles that are shipped by FreeIPA and imported into Dogtag are defined here. The configurations for the LDAP, Apache HTTPS and KDC certificates are found here.</p>
</dd>
</dl>
<p>I’ll explain which configuration file is used for which certificate later on in this post.</p>
<h2 id="specifying-the-validity-period">Specifying the validity period</h2>
<p>The configuration field for setting the validity period are:</p>
<pre><code>&lt;component&gt;.default.params.range=720
&lt;component&gt;.constraint.params.range=720</code></pre>
<p>where <code>&lt;component&gt;</code> is some key, usually a numeric index, that may be different for different profiles. The actual profile component classes are <code>ValidityDefault</code> and <code>ValidityConstraint</code>, or <code>{CA,User}Validity{Default,Constraint}</code> for some profiles.</p>
<p>The <code>default</code> component sets the default validity period for this profile, whereas the constraint sets the <em>maximum</em> duration in case the user overrides it. Note that if an override configuration overrides the <code>default</code> value such that it exceeds the <code>constraint</code> specified in the underlying configuration, issuance will fail due to constraint violation. It is usually best to specify both the <code>default</code> and <code>constraint</code> together, with the same value.</p>
<p>The default range unit is <code>day</code>, so the configuration above means <em>720 days</em>. Use the <code>rangeUnit</code> parameter to specify a different unit. The supported units are <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code> and <code>minute</code>. For example:</p>
<pre><code>&lt;component&gt;.default.params.range=3
&lt;component&gt;.default.params.rangeUnit=month
&lt;component&gt;.constraint.params.range=3
&lt;component&gt;.constraint.params.rangeUnit=month</code></pre>
<h2 id="which-configuration-for-which-certificate">Which configuration for which certificate?</h2>
<dl>
<dt>CA certificate (when self-signed)</dt>
<dd><p><code>/usr/share/pki/ca/conf/caCert.profile</code></p>
</dd>
<dt>OCSP signing certificate</dt>
<dd><p><code>/usr/share/pki/ca/conf/caOCSPCert.profile</code></p>
</dd>
<dt>Subsystem certificate</dt>
<dd><p><code>/usr/share/pki/ca/conf/rsaSubsystemCert.profile</code> when using RSA keys (the default)</p>
</dd>
<dt>Dogtag HTTPS certificate</dt>
<dd><p><code>/usr/share/pki/ca/conf/rsaServerCert.profile</code> when using RSA keys (the default)</p>
</dd>
<dt>Audit signing</dt>
<dd><p><code>/usr/share/pki/ca/conf/caAuditSigningCert.profile</code></p>
</dd>
<dt>IPA RA agent (FreeIPA-specific)</dt>
<dd><p><code>/usr/share/pki/ca/profiles/ca/caServerCert.cfg</code></p>
</dd>
<dt>Apache and LDAP certificates (FreeIPA-specific)</dt>
<dd><p><code>/usr/share/ipa/profiles/caIPAserviceCert.cfg</code></p>
</dd>
<dt>KDC certificate (FreeIPA-specific)</dt>
<dd><p><code>/usr/share/ipa/profiles/KDCs_PKINIT_Certs.cfg</code></p>
</dd>
</dl>
<h2 id="testing">Testing</h2>
<p>I made changes to the files mentioned above, so that certificates would be issued with the following validity periods:</p>
<table>
<tbody>
<tr class="odd">
<td>CA</td>
<td>5 years</td>
</tr>
<tr class="even">
<td>OCSP</td>
<td>1 year</td>
</tr>
<tr class="odd">
<td>Subsystem</td>
<td>6 months</td>
</tr>
<tr class="even">
<td>HTTPS</td>
<td>3 months</td>
</tr>
<tr class="odd">
<td>Audit</td>
<td>1 year</td>
</tr>
<tr class="even">
<td>IPA RA</td>
<td>15 months</td>
</tr>
<tr class="odd">
<td>Apache</td>
<td>4 months</td>
</tr>
<tr class="even">
<td>LDAP</td>
<td>4 months</td>
</tr>
<tr class="odd">
<td>KDC</td>
<td>18 months</td>
</tr>
</tbody>
</table>
<p>I installed FreeIPA (with a self-signed CA). After installation completed, I had a look at the certificates that were being tracked by Certmonger. For reference, the installation took place on March 4, 2019 (<strong>2019-03-04</strong>).</p>
<pre><code># getcert list |egrep '^Request|certificate:|expires:'
Request ID '20190304044028':
  certificate: type=FILE,location='/var/lib/ipa/ra-agent.pem'
  expires: 2020-06-04 15:40:30 AEST
Request ID '20190304044116':
  certificate: type=NSSDB,location='/etc/pki/pki-tomcat/alias',nickname='auditSigningCert cert-pki-ca',token='NSS Certificate DB'
  expires: 2020-03-04 15:39:53 AEDT
Request ID '20190304044117':
  certificate: type=NSSDB,location='/etc/pki/pki-tomcat/alias',nickname='ocspSigningCert cert-pki-ca',token='NSS Certificate DB'
  expires: 2020-03-04 15:39:53 AEDT
Request ID '20190304044118':
  certificate: type=NSSDB,location='/etc/pki/pki-tomcat/alias',nickname='subsystemCert cert-pki-ca',token='NSS Certificate DB'
  expires: 2019-09-04 15:39:53 AEST
Request ID '20190304044119':
  certificate: type=NSSDB,location='/etc/pki/pki-tomcat/alias',nickname='caSigningCert cert-pki-ca',token='NSS Certificate DB'
  expires: 2024-03-04 15:39:51 AEDT
Request ID '20190304044120':
  certificate: type=NSSDB,location='/etc/pki/pki-tomcat/alias',nickname='Server-Cert cert-pki-ca',token='NSS Certificate DB'
  expires: 2019-06-04 15:39:53 AEST
Request ID '20190304044151':
  certificate: type=NSSDB,location='/etc/dirsrv/slapd-IPA-LOCAL',nickname='Server-Cert',token='NSS Certificate DB'
  expires: 2019-07-04 15:41:52 AEST
Request ID '20190304044225':
  certificate: type=FILE,location='/var/lib/ipa/certs/httpd.crt'
  expires: 2019-07-04 15:42:26 AEST
Request ID '20190304044234':
  certificate: type=FILE,location='/var/kerberos/krb5kdc/kdc.crt'
  expires: 2020-09-04 15:42:34 AEST</code></pre>
<p>Observe that the certificate have the intended periods.</p>
<h2 id="discussion">Discussion</h2>
<p>The procedure outlined in this post is not officially supported, and not recommended. But the desire to choose different validity periods is sometimes justified, especially for the CA certificate. So should FreeIPA allow customisation of the system certificate validity periods? To what extent?</p>
<p>We need to reduce the default CA validity from 20 years, given the 2048-bit key size. (There is a separate issue to support generating a larger CA signing key, too). Whether the CA validity period should be configurable is another question. My personal opinion is that it makes sense to allow the customer to choose the CA lifetime.</p>
<p>For system certificates, I think that customers should just accept the defaults. PKI systems are trending to shorter lifetimes for end-entity certificates, which is a good thing. For FreeIPA, unfortunately we are still dealing with a lot of certificate renewal issues that arise from the complex architecture. Until we are confident in the robustness of the renewal system, and have observed a reduction in customer issues, it would be a mistake to substantially reduce the validity period for system certificates. Likewise, it is not yet a good idea to let customers choose the certificate validity periods.</p>
<p>On the other hand, the team is considering changing the default validity period of system certificates <em>a little bit</em>, so that different certificates are on different renewal candences. This would simplify recovery in some scenarios: it is easier to recover when only <em>some</em> of the certificates expired, instead of <em>all</em> of them at once.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2019-08-02-validity-exceeding-ca.html">Certificates need not be limited to the CA’s validity period</a>
        </li>
    
        <li>
            <a href="../posts/2019-07-26-dogtag-replica-ranges.html">Dogtag replica range management</a>
        </li>
    
        <li>
            <a href="../posts/2019-07-19-revocation-self-service.html">Designing revocation self-service for FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2019-05-28-a-dn-is-not-a-string.html">A Distinguished Name is not a string</a>
        </li>
    
        <li>
            <a href="../posts/2019-05-24-ipa-cert-fix.html">Fixing expired system certificates in FreeIPA</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
