<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - DN attribute value encoding in X.509</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'certificates'." href="../tags/certificates.html">certificates</a>, <a title="All pages tagged 'asn1'." href="../tags/asn1.html">asn1</a>, <a title="All pages tagged 'gotchas'." href="../tags/gotchas.html">gotchas</a>
    
</div>

<div id="postContent">
    <h1 id="dn-attribute-value-encoding-in-x.509">DN attribute value encoding in X.509</h1>
<p>X.509 certificates use the X.500 <em>Distinguished Name (DN)</em> data type to represent issuer and subject names. X.500 names may contain a variety of fields including <em>CommonName</em>, <em>OrganizationName</em>, <em>Country</em> and so on. This post discusses how these values are encoded and compared, and problematic circumstances that can arise.</p>
<h2 id="asn.1-string-types-and-encodings">ASN.1 string types and encodings</h2>
<p>ASN.1 offers a large number of string types, including:</p>
<ul>
<li><code>NumericString</code></li>
<li><code>PrintableString</code></li>
<li><code>IA5String</code></li>
<li><code>UTF8String</code></li>
<li><code>BMPString</code></li>
<li>…several others</li>
</ul>
<p>When serialising an ASN.1 object, each of these string types has a different tag. Some of the types have a shared representation for serialisation but differ in which characters they allow. For example, <code>NumericString</code> and <code>PrintableString</code> are both represented in DER using one byte per character. But <code>NumericString</code> only allows digits (<code>0</code>–<code>9</code>) and <code>SPACE</code>, whereas <code>PrintableString</code> admits the full set of ASCII printable characters. In contrast, <code>BMPString</code> uses two bytes to represent each character; it is equivalent to UTF-16BE. <code>UTF8String</code>, unsurprisingly, uses UTF-8.</p>
<h2 id="asn.1-string-types-for-x.509-name-attributes">ASN.1 string types for X.509 name attributes</h2>
<p>Each of the various X.509 name attribute types uses a specific ASN.1 string type. Some types have a size constraint. For example:</p>
<pre><code>X520countryName      ::= PrintableString (SIZE (2))
DomainComponent      ::= IA5String
X520CommonName       ::= DirectoryName (SIZE (1..64))
X520OrganizationName ::= DirectoryName (SIZE (1..64))</code></pre>
<p>Hold on, what is <code>DirectoryName</code>? It is not a universal ASN.1 type; it is specified as a sum of string types:</p>
<pre><code>DirectoryName ::= CHOICE {
    teletexString     TeletexString,
    printableString   PrintableString,
    universalString   UniversalString,
    utf8String        UTF8String,
    bmpString         BMPString }</code></pre>
<p>Note that a size constraint on <code>DirectoryName</code> propagates to each of the cases. The constraint gives a maximum length in <em>characters</em>, not bytes.</p>
<p>Most X.509 attribute types use <code>DirectoryName</code>, including <em>common name (CN)</em>, <em>organization name (O)</em>, <em>organizational unit (OU)</em>, <em>locality (L)</em>, <em>state or province name (ST)</em>. For these attribute types, which encoding should be used? <a href>RFC 5280 §4.1.2.6</a> provides some guidance:</p>
<pre><code>The DirectoryString type is defined as a choice of PrintableString,
TeletexString, BMPString, UTF8String, and UniversalString.  CAs
conforming to this profile MUST use either the PrintableString or
UTF8String encoding of DirectoryString, with two exceptions.</code></pre>
<p>The current version of X.509 only allows <code>PrintableString</code> and <code>UTF8String</code>. Earlier versions allowed any of the types in <code>DirectoryString</code>. The <em>exceptions</em> mentioned are grandfather clauses that permit the use of the now-prohibited types in environments that were already using them.</p>
<p>So for strings containing non-ASCII code points <code>UTF8String</code> is the only type you can use. But for ASCII-only strings, there is still a choice, and the RFC does not make a recommendation on which to use. Both are common in practice.</p>
<p>This poses an interesting question. Suppose two encoded DNs have the same attributes in the same order, but differ in the string encodings used. Are they the same DN?</p>
<h2 id="comparing-dns">Comparing DNs</h2>
<p><a href="https://tools.ietf.org/html/rfc5280#section-7.1">RFC 5280 §7.1</a> outlines the procedure for comparing DNs. To compare strings you must convert them to Unicode, translate or drop some special-purpose characters, and perform case folding and normalisation. The resulting strings are then compared case-insensitively. According to this rule, DNs that use different string encodings but are otherwise the same are <strong>equal</strong>.</p>
<p>But the situation is more complex in practice. Earlier versions of X.509 required only binary comparison of DNs. For example, <a href="https://tools.ietf.org/html/rfc3280">RFC 3280</a> states:</p>
<pre><code>Conforming implementations are REQUIRED to implement the following
name comparison rules:

   (a)  attribute values encoded in different types (e.g.,
   PrintableString and BMPString) MAY be assumed to represent
   different strings;

   (b) attribute values in types other than PrintableString are case
   sensitive (this permits matching of attribute values as binary
   objects);

   (c)  attribute values in PrintableString are not case sensitive
   (e.g., &quot;Marianne Swanson&quot; is the same as &quot;MARIANNE SWANSON&quot;); and

   (d)  attribute values in PrintableString are compared after
   removing leading and trailing white space and converting internal
   substrings of one or more consecutive white space characters to a
   single space.</code></pre>
<p>Futhermore, RFC 5280 and earlier versions of X.509 state:</p>
<pre><code>The X.500 series of specifications defines rules for comparing
distinguished names that require comparison of strings without regard
to case, character set, multi-character white space substring, or
leading and trailing white space.  This specification relaxes these
requirements, requiring support for binary comparison at a minimum.</code></pre>
<p>This is a contradiction. The above states that binary comparison of DNs is acceptable, but other sections require a more sophisticated comparison algorithm. The combination of this contradiction, historical considerations and (no doubt) programmer laziness means that many X.509 implementations only perform <strong>binary comparison</strong> of DNs.</p>
<h2 id="how-cas-should-handle-dn-attribute-encoding">How CAs should handle DN attribute encoding</h2>
<p>To ease certification path construction with clients that only perform binary matching of DNs, RFC 5280 states the following requirement:</p>
<pre><code>When the subject of the certificate is a CA, the subject
field MUST be encoded in the same way as it is encoded in the
issuer field (Section 4.1.2.4) in all certificates issued by
the subject CA.  Thus, if the subject CA encodes attributes
in the issuer fields of certificates that it issues using the
TeletexString, BMPString, or UniversalString encodings, then
the subject field of certificates issued to that CA MUST use
the same encoding.</code></pre>
<p>This is confusing wording, but in practical terms there are two requirements:</p>
<ol type="1">
<li>The Issuer DN on a certificate must be byte-identical to the Subject DN of the CA that issued it.</li>
<li>The attribute encodings in a CA’s Subject DN must not change (e.g. when the CA certificate gets renewed).</li>
</ol>
<p>If a CA violates either of these requirements breakage will ensue. Programs that do binary DN comparison will be unable to construct a certification path to the CA.</p>
<p>For <em>end-entity</em> (or <em>leaf</em>) certificates, the subject DN is not use in any links of the certification path. Changing the subject attribute encoding when renewing an end-entity certificate will not break validation. But it could still confuse some programs that only do binary comparison of DNs (e.g. they might display two distinct subjects).</p>
<h2 id="processing-certificate-requests">Processing certificate requests</h2>
<p>What about when processing certificate requests—should CAs respect the attribute encodings in the CSR? In my experience, CA programs are prone to issuing certificates with the subject encoded differently from how it was encoded in the CSR. CAs may do various kinds of validation, substitution or addition of subject name attributes. Or they may enforce the use of a particular encoding regardless of the encoding in the CSR.</p>
<p>Is this a problem? It depends on the client program. In my experience most programs can handle this situation. Problems mainly arise when the issuer or subject encoding changes <em>upon renewal</em> (for the reasons discussed above).</p>
<p>If a CSR-versus-certificate encoding mismatch does cause a problem for you, you may have to create a new CSR with the attributes encoding you expect the CA to use for the certificate. In many programs this is not straightforward, if it is possible at all. If you control the CA you might be able to configure it to use particular encodings for string attributes, or to respect the encodings in the CSR. The options available and how to configure them vary among CA programs.</p>
<h2 id="recap">Recap</h2>
<p>X.509 requires the use of either <code>PrintableString</code> or <code>UTF8String</code> for most DN attribute types. Strings consisting of printable 7-bit ASCII characters can be represented using either encoding. This ambiguity can lead to problems in certification path construction.</p>
<p>Formally, two DNs that have the same attributes and values are the same DN, regardless of the string encodings used. But there are many programs that only perform binary matching of DNs. To avoid causing problems for such programs a CA:</p>
<ul>
<li><em>must</em> ensure that the Issuer DN field on all certificates it issues is identical to its own Subject DN;</li>
<li><em>must</em> ensure that Subject DN attribute encodings on CA certificates it issues to a given subject do not change upon renewal;</li>
<li><em>should</em> ensure that Subject DN attribute encodings on end-entity certificates it issues to a given subject do not change upon renewal.</li>
</ul>
<p>CAs will often issue certificates with values encoded differently from how they were presented in the CSR. This usually does not cause problems. But if it does cause problems, you might be able to configure the client program to produce a CSR with different attribute encodings. If you control the CA you may be able to configure it to have a different treatment for attribute encodings. How to do these things was beyond the scope of this article.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2020-12-01-openshift-crio-userns.html">User namespaces in OpenShift via CRI-O annotations</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-30-openshift-machine-config-operator.html">Using the OpenShift Machine Config Operator</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-13-acme-service-discovery.html">ACME Service Discovery</a>
        </li>
    
        <li>
            <a href="../posts/2020-11-05-openshift-user-namespace.html">OpenShift and user namespaces</a>
        </li>
    
        <li>
            <a href="../posts/2020-10-20-ipa-cert-long-hostname.html">Issuing certificates for long hostnames</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
