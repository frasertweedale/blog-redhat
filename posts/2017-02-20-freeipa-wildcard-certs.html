<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Wildcard certificates in FreeIPA</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div id="postContent">
    <h1 id="wildcard-certificates-in-freeipa">Wildcard certificates in FreeIPA</h1>
<p>The FreeIPA team sometimes gets asked about wildcard certificate support. A wildcard certificate is an X.509 certificate where the DNS-ID has a wildcard in it (typically as the most specific domain component, e.g. <code>*.cloudapps.example.com</code>). Most TLS libraries match wildcard domains in the obvious way.</p>
<p>In this blog post we will discuss the state of wildcard certificates in FreeIPA, but before proceeding it is fitting to point out that <a href="https://tools.ietf.org/html/rfc6125#section-7.2">wildcard certificates are deprecated</a>, and for good reason. While the compromise of any TLS private key is a serious matter, the attacker can only impersonate the entities whose names appear on the certificate (typically one or a handful of DNS addresses). But a wildcard certificate can impersonate <em>any</em> host whose name happens to match the wildcard value.</p>
<p>In time, validation of wildcard domains will be disabled by default and (hopefully) eventually removed from TLS libraries. The emergence of protocols like ACME that allow automated domain validation and certificate issuance mean that there is no real need for wildcard certificates anymore, but a lot of programs are yet to implement ACME or similar; therefore there is still a perceived need for wildcard certificates. In my opinion some of this boils down to lack of awareness of novel solutions like ACME, but there can also be a lack of willingness to spend the time and money to implement them, or a desire to avoid changing deployed systems, or taking a “wait and see” approach when it comes to new, security-related protocols or technologies. So for the time being, some organisations have good reasons to want wildcard certificates.</p>
<p>FreeIPA currently has no special support for wildcard certificates, but with support for custom certificate profiles, we can create and use a profile for issuing wildcard certificates.</p>
<h2 id="creating-a-wildcard-certificate-profile-in-freeipa">Creating a wildcard certificate profile in FreeIPA</h2>
<p>This procedure works on FreeIPA 4.2 (RHEL 7.2) and later.</p>
<p>First, <code>kinit admin</code> and export an existing service certificate profile configuration to a file:</p>
<pre><code>ftweedal% ipa certprofile-show caIPAserviceCert --out wildcard.cfg
---------------------------------------------------
Profile configuration stored in file 'wildcard.cfg'
---------------------------------------------------
  Profile ID: caIPAserviceCert
  Profile description: Standard profile for network services
  Store issued certificates: TRUE</code></pre>
<p>Modify the profile; the minimal diff is:</p>
<pre><code>--- wildcard.cfg.bak
+++ wildcard.cfg
@@ -19 +19 @@
-policyset.serverCertSet.1.default.params.name=CN=$request.req_subject_name.cn$, o=EXAMPLE.COM
+policyset.serverCertSet.1.default.params.name=CN=*.$request.req_subject_name.cn$, o=EXAMPLE.COM
@@ -108 +108 @@
-profileId=caIPAserviceCert
+profileId=wildcard</code></pre>
<p>Now import the modified configuration as a new profile called <code>wildcard</code>:</p>
<pre><code>ftweedal% ipa certprofile-import wildcard \
    --file wildcard.cfg \
    --desc 'Wildcard certificates' \
    --store 1
---------------------------
Imported profile &quot;wildcard&quot;
---------------------------
  Profile ID: wildcard
  Profile description: Wildcard certificates
  Store issued certificates: TRUE</code></pre>
<p>Next, set up a CA ACL to allow the <code>wildcard</code> profile to be used with the <code>cloudapps.example.com</code> host:</p>
<pre><code>ftweedal% ipa caacl-add wildcard-hosts
-----------------------------
Added CA ACL &quot;wildcard-hosts&quot;
-----------------------------
  ACL name: wildcard-hosts
  Enabled: TRUE

ftweedal% ipa caacl-add-profile wildcard-hosts --certprofiles wildcard
  ACL name: wildcard-hosts
  Enabled: TRUE
  CAs: ipa
  Profiles: wildcard
-------------------------
Number of members added 1
-------------------------

ftweedal% ipa caacl-add-host wildcard-hosts --hosts cloudapps.example.com
  ACL name: wildcard-hosts
  Enabled: TRUE
  CAs: ipa
  Profiles: wildcard
  Hosts: cloudapps.example.com
-------------------------
Number of members added 1
-------------------------</code></pre>
<p>An additional step is required in FreeIPA 4.4 (RHEL 7.3) and later (it does not apply to FreeIPA &lt; 4.4):</p>
<pre><code>ftweedal% ipa caacl-add-ca wildcard-hosts --cas ipa
  ACL name: wildcard-hosts
  Enabled: TRUE
  CAs: ipa
-------------------------
Number of members added 1
-------------------------</code></pre>
<p>Then create a CSR with subject <code>CN=cloudapps.example.com</code> (details omitted), and issue the certificate:</p>
<pre><code>ftweedal% ipa cert-request my.csr \
    --principal host/cloudapps.example.com \
    --profile wildcard
  Issuing CA: ipa
  Certificate: MIIEJzCCAw+gAwIBAgIBCzANBgkqhkiG9w0BAQsFADBBMR8...
  Subject: CN=*.cloudapps.example.com,O=EXAMPLE.COM
  Issuer: CN=Certificate Authority,O=EXAMPLE.COM
  Not Before: Mon Feb 20 04:21:41 2017 UTC
  Not After: Thu Feb 21 04:21:41 2019 UTC
  Serial number: 11
  Serial number (hex): 0xB</code></pre>
<p>Alternatively, you can use Certmonger to request the certificate:</p>
<pre><code>ftweedal% ipa-getcert request \
  -d /etc/httpd/alias -p /etc/httpd/alias/pwdfile.txt \
  -n wildcardCert \
  -T wildcard</code></pre>
<p>This will request a certificate for the current host. The <code>-T</code> option specifies the profile to use.</p>
<h2 id="discussion">Discussion</h2>
<p>Observe that the subject common name (CN) in the CSR <em>does not contain the wildcard</em>. FreeIPA requires naming information in the CSR to perfectly match the subject principal. As mentioned in the introduction, FreeIPA has no specific support for wildcard certificates, so if a wildcard were included in the CSR, it would not match the subject principal and the request would be rejected.</p>
<p>When constructing the certificate, Dogtag performs a variable substitution into a subject name string. That string contains the literal wildcard and the period to its right, and the common name (CN) from the CSR gets substituted in after that. The relevant line in the profile configuration is:</p>
<pre><code>policyset.serverCertSet.1.default.params.name=CN=*.$request.req_subject_name.cn$, o=EXAMPLE.COM</code></pre>
<p>When it comes to wildcards in <em>Subject Alternative Name</em> DNS-IDs, it might be possible to configure a Dogtag profile to add this in a similar way to the above, but I do not recommend it, nor am I motivated to work out a reliable way to do this, given that wildcard certificates are deprecated. (By the time TLS libraries eventually remove support for treating the subject CN as a DNS-ID, I will have little sympathy for organisations that still haven’t moved away from wildcard certs).</p>
<p>In conclusion: you shouldn’t use wildcard certificates, and FreeIPA has no special support for them, but if you really need to, you can do it with a custom certificate profile.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2018-03-15-x509-dn-attribute-encoding.html">DN attribute value encoding in X.509</a>
        </li>
    
        <li>
            <a href="../posts/2017-11-22-changing-ca-subject-dn-part-ii-freeipa.html">Changing a CA’s Subject DN; Part II: FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2017-11-20-changing-ca-subject-dn-part-i.html">Changing a CA’s Subject DN; Part I: Don’t Do That</a>
        </li>
    
        <li>
            <a href="../posts/2017-11-10-freeipa-changing-signature-algorithm.html">Changing the X.509 signature algorithm in FreeIPA</a>
        </li>
    
        <li>
            <a href="../posts/2017-09-04-keycloak-openshift.html">Running Keycloak in OpenShift</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
