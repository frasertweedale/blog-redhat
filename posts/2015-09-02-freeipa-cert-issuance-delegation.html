<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Fraser's IdM Blog - Delegating certifiate issuance in FreeIPA</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Fraser's IdM Blog</a>
            </div>
            <div id="navigation">
                <a href="../">Home</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <div class="info">
    
    Tags: <a title="All pages tagged 'freeipa'." href="../tags/freeipa.html">freeipa</a>, <a title="All pages tagged 'certificates'." href="../tags/certificates.html">certificates</a>
    
</div>

<div id="postContent">
    <h1 id="delegating-certifiate-issuance-in-freeipa">Delegating certifiate issuance in FreeIPA</h1>
<p><a href="http://www.freeipa.org/page/Releases/4.2.0">FreeIPA 4.2</a> brings several certificate management improvements including custom profiles and user certificates. Along with the explosion in certificate use cases that are now support comes the question of how to manage certificate issuance, along two dimensions: which entities can be issued what kinds of certificates, and who can actually request a certificate? The first aspect is managed via CA ACLs, which were <a href="2015-08-06-freeipa-custom-certprofile.html">explained in a previous article</a>. In this post I detail how FreeIPA decides whether a requesting principal is allowed to request a certificate for the subject principal, and how to delegate the authority to issue certificates.</p>
<h2 id="self-service-requests">Self-service requests <a href="#self-service-requests">§</a></h2>
<p>The simplest scenario is a principal using <code>cert-request</code> to request a certificate for itself as the certificate subject. This action is permitted for user and host principals but the request is <strong>still subject to CA ACLs</strong>; if no CA ACL permits issuance for the combination of subject principal and certificate profile, the request will fail.</p>
<p>Implementation-wise, self-service works because there are directory server ACIs that permit bound principals to modify their own <code>userCertificate</code> attribute; there is no explicit permission object.</p>
<h2 id="hosts">Hosts <a href="#hosts">§</a></h2>
<p>Hosts may request certificates for any hosts and services that are <em>managed by</em> the requesting host. These relationships are managed via the <code>ipa host-{add,remove}-managedby</code> commands, and a single host or service may be managed by multiple hosts.</p>
<p>This rule is implemented using directory server ACIs that allow hosts to write the <code>userCertificate</code> attribute when the <code>managedby</code> relationship exists, otherwise not. In the IPA framework, we conduct a permission check to see if the bound (requesting) principal can write the subject principal’s attribute. This is nicer (and probably faster) than interpreting the <code>managedby</code> attribute in the FreeIPA framework.</p>
<p>If you are interested, the ACI rules look like this:</p>
<pre><code>dn: cn=services,cn=accounts,$SUFFIX
aci: (targetattr=&quot;userCertificate || krbPrincipalKey&quot;)(version 3.0;
      acl &quot;Hosts can manage service Certificates and kerberos keys&quot;;
      allow(write) userattr = &quot;parent[0,1].managedby#USERDN&quot;;)

dn: cn=computers,cn=accounts,$SUFFIX
aci: (targetattr=&quot;userCertificate || krbPrincipalKey&quot;)(version 3.0;
      acl &quot;Hosts can manage other host Certificates and kerberos keys&quot;;
      allow(write) userattr = &quot;parent[0,1].managedby#USERDN&quot;;)</code></pre>
<p>As usual, these requests are also subject to CA ACLs.</p>
<p>Finally, <em>subjectAltName</em> <em>dNSName</em> values are matched against hosts (if the subject principal is a host) or services (if it’s a service); they are treated as additional subject principals and the same permission and CA ACL checks are carried out for each.</p>
<h2 id="users">Users <a href="#users">§</a></h2>
<p>FreeIPA’s <em>Role Based Access Control</em> (RBAC) system is used to assign certificate issuance permissions to users (or other principal types). There are several permissions related to certificate management:</p>
<dl>
<dt><em>Request Certificate</em></dt>
<dd><p>The main permission that allows a user to request certificates for other principals.</p>
</dd>
<dt><em>Request Certificate with SubjectAltName</em></dt>
<dd><p>This permission allows a user (one who already has <em>Request Certificate</em> permission) to request a certificate with the <em>subjectAltName</em> extension (the check is skipped when the request is self-service or initated by a host principal). Regardless of this permission we comprehensively validate the SAN extension whenever present in a CSR (and always have), so I’m not sure why this exists as a separate permission. I proposed to remove this permission and allow SAN by default but the conversation died.</p>
</dd>
<dt><em>Request Certificate ignoring CA ACLs</em> (new in FreeIPA 4.2)</dt>
<dd><p>The main use case for this permission is where a certain profile is not appropriate for self-service. For example, if you want to issue certificates bearing some estoeric or custom extension unknown to (and therefore not validatable by) FreeIPA, you can define a profile that copies the extension data verbatim from the CSR. Such a profile ought not be made available for self-service via CA ACLs, but this permission will allow a privileged user to issue the certificates on behalf of others.</p>
</dd>
<dt><em>System: Manage User Certificates</em> (new in FreeIPA 4.2.1)</dt>
<dd><p>Permits writing the <code>userCertificate</code> attribute of user entries.</p>
</dd>
<dt><em>System: Manage Host Certificates</em></dt>
<dd><p>Permits writing the <code>userCertificate</code> attribute of host entries.</p>
</dd>
<dt><em>System: Modify Services</em></dt>
<dd><p>Permits writing the <code>userCertificate</code> attribute of service entries.</p>
</dd>
</dl>
<p>There are other permissions related to revocation and retrieving certificate information from the Dogtag CA. It might make sense for certificate administrators to have some of these permissions but they are not needed for issuance and I will not detail them here.</p>
<p>The RBAC system is used to group <em>permissions</em> into <em>privileges</em> and privileges into <em>roles</em>. Users, user groups, hosts, host groups and services can then be assigned to a role. Let’s walk through an example: we want members of the <code>user-cert-managers</code> group to be able to issue certificates for users. The SAN extension will be allowed, but CA ACLs may not be bypassed.</p>
<p>It bears mention that there is a default privilege called <em>Certificate Administrators</em> that contains most of the certificate management permissions; for this example we will create a new privilege that contains <em>only</em> the required permissions. We will use the <code>ipa</code> CLI program to implement this scenario, but it can also be done using the web UI. Assuming we have a privileged Kerberos ticket, let’s first create a new <em>privilege</em> and add to it the required permissions:</p>
<pre><code>ftweedal% ipa privilege-add &quot;Issue User Certificate&quot;
----------------------------------------
Added privilege &quot;Issue User Certificate&quot;
----------------------------------------
  Privilege name: Issue User Certificate

ftweedal% ipa privilege-add-permission &quot;Issue User Certificate&quot; \
    --permission &quot;Request Certificate&quot; \
    --permission &quot;Request Certificate with SubjectAltName&quot; \
    --permission &quot;System: Manage User Certificates&quot;
  Privilege name: Issue User Certificate
  Permissions: Request Certificate,
               Request Certificate with SubjectAltName,
               System: Manage User Certificates
-----------------------------
Number of permissions added 3
-----------------------------</code></pre>
<p>Next we create a new <em>role</em> and add the privilege we just created:</p>
<pre><code>ftweedal% ipa role-add &quot;User Certificate Manager&quot;
-------------------------------------
Added role &quot;User Certificate Manager&quot;
-------------------------------------
  Role name: User Certificate Manager

ftweedal% ipa role-add-privilege &quot;User Certificate Manager&quot; \
    --privilege &quot;Issue User Certificate&quot;
  Role name: User Certificate Manager
  Privileges: Issue User Certificate
----------------------------
Number of privileges added 1
----------------------------</code></pre>
<p>Finally we add the <code>user-cert-managers</code> group (which we assume already exists) to the role:</p>
<pre><code>ftweedal% ipa role-add-member &quot;User Certificate Manager&quot; \
    --groups user-cert-managers
  Role name: User Certificate Manager
  Member groups: user-cert-managers
  Privileges: Issue User Certificate
-------------------------
Number of members added 1
-------------------------</code></pre>
<p>With that, users who are members of the <code>user-cert-managers</code> group will be able to request certificates for all users.</p>
<h2 id="conclusion">Conclusion <a href="#conclusion">§</a></h2>
<p>In addition to self-service, FreeIPA offers a couple of ways to delegate certificate request permissions. For hosts, the <code>managedby</code> relationship grants permission to request certificates for services and other hosts. For users, RBAC can be used to grant permission to manage user, host and service principals, even separately as needs dictate. In all cases except where the RBAC <em>Request Certificate ignoring CA ACLs</em> permission applies, CA ACLs are enforced.</p>
<p>Looking ahead, I can see scope for augmenting or complementing CA ACLs - which currently are concerned with the <em>subject</em> or target principal and care nothing about the <em>requesting</em> principal - with a mechanism to control which principals may <em>issue</em> requests involving a particular profile. But how much this is wanted we will wait and see; it is one of many possible improvents to FreeIPA’s certificate management and all will have to be judged according to the demand and impact.</p>
</div>
<div id="postFooter">
    <div id="recent">
Recent posts:
<ul>
    
        <li>
            <a href="../posts/2021-06-29-openshift-live-changes.html">Live-testing changes in OpenShift clusters</a>
        </li>
    
        <li>
            <a href="../posts/2021-06-09-systemd-cgroups-subuid.html">systemd, cgroups and subuid ranges</a>
        </li>
    
        <li>
            <a href="../posts/2021-05-27-oci-runtime-spec-runc.html">Using <code>runc</code> to explore the OCI Runtime Specification</a>
        </li>
    
        <li>
            <a href="../posts/2021-03-30-openshift-cgroupv2-systemd.html">systemd containers on OpenShift with cgroups v2</a>
        </li>
    
        <li>
            <a href="../posts/2021-03-10-openshift-user-namespace-multi-user.html">Multiple users in user namespaces on OpenShift</a>
        </li>
    
</ul>

<div id="recentLinks">
    <a type="application/atom+xml" href="../atom.xml">Atom feed</a>
     <!-- em space -->
    <a href="../archive.html">All posts…</a>
</div>

</div>

    <div id="license">
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        <img alt="Creative Commons License" style="border-width:0" src="https://licensebuttons.net/l/by/4.0/88x31.png">
    </a>
    <br />
    Except where otherwise noted, this work is licensed under a
    <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">
        Creative Commons Attribution 4.0 International License
    </a>.
</div>

</div>

        </div>
        <div class="clear"></div>
        <div id="footer">
            Generated by
            <a href="https://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
